#include <assert.h>
#include <limits.h>
#include <math.h>

#define ACCURACY (16)

/*
 * This datastructure resembles a fixed-point precision number,
 * having a value of `m * 2^-ACCURACY`.
 */
typedef int64_t fpp;

static inline fpp
fpp_of(int m) { return ((int64_t)m) * (1 << ACCURACY); }

static inline int32_t
fpp_rint(fpp x) { return (x + (1 << (ACCURACY-1))) >> ACCURACY; }

static inline fpp
fpp_neg(fpp x) { return -x; }

static inline fpp
fpp_half(fpp x) { return x>>1; }

static inline fpp
fpp_add(fpp a, fpp b) { return a + b; }

static inline fpp
fpp_sub(fpp a, fpp b) { return a - b; }

static inline fpp
fpp_div(fpp a, fpp b)
{
	int64_t aa, bb;

	aa = a;
	aa *= (1 << ACCURACY);
	bb = b;

	return aa / bb;
}

const int64_t fpp_gm_tab[] = {
	      0,       0,       0, 1048576,  741455,  741455, -741455,  741455,
	 968758,  401273, -401273,  968758,  401273,  968758, -968758,  401273,
	1028428,  204567, -204567, 1028428,  582558,  871859, -871859,  582558,
	 871859,  582558, -582558,  871859,  204567, 1028428,-1028428,  204567,
	1043527,  102778, -102778, 1043527,  665210,  810560, -810560,  665210,
	 924761,  494295, -494295,  924761,  304386, 1003425,-1003425,  304386,
	1003425,  304386, -304386, 1003425,  494295,  924761, -924761,  494295,
	 810560,  665210, -665210,  810560,  102778, 1043527,-1043527,  102778,
	1047313,   51451,  -51451, 1047313,  704181,  776944, -776944,  704181,
	 947901,  448324, -448324,  947901,  353255,  987281, -987281,  353255,
	1017151,  254783, -254783, 1017151,  539076,  899394, -899394,  539076,
	 842224,  624636, -624636,  842224,  153858, 1037227,-1037227,  153858,
	1037227,  153858, -153858, 1037227,  624636,  842224, -842224,  624636,
	 899394,  539076, -539076,  899394,  254783, 1017151,-1017151,  254783,
	 987281,  353255, -353255,  987281,  448324,  947901, -947901,  448324,
	 776944,  704181, -704181,  776944,   51451, 1047313,-1047313,   51451,
	1048260,   25733,  -25733, 1048260,  723036,  759428, -759428,  723036,
	 958618,  424926, -424926,  958618,  377377,  978314, -978314,  377377,
	1023098,  229744, -229744, 1023098,  560986,  885893, -885893,  560986,
	 857300,  603779, -603779,  857300,  179267, 1033138,-1033138,  179267,
	1040690,  128357, -128357, 1040690,  645117,  826641, -826641,  645117,
	 912352,  516841, -516841,  912352,  279669, 1010592,-1010592,  279669,
	 995652,  328919, -328919,  995652,  471452,  936614, -936614,  471452,
	 793991,  684901, -684901,  793991,   77138, 1045735,-1045735,   77138,
	1045735,   77138,  -77138, 1045735,  684901,  793991, -793991,  684901,
	 936614,  471452, -471452,  936614,  328919,  995652, -995652,  328919,
	1010592,  279669, -279669, 1010592,  516841,  912352, -912352,  516841,
	 826641,  645117, -645117,  826641,  128357, 1040690,-1040690,  128357,
	1033138,  179267, -179267, 1033138,  603779,  857300, -857300,  603779,
	 885893,  560986, -560986,  885893,  229744, 1023098,-1023098,  229744,
	 978314,  377377, -377377,  978314,  424926,  958618, -958618,  424926,
	 759428,  723036, -723036,  759428,   25733, 1048260,-1048260,   25733,
	1048497,   12868,  -12868, 1048497,  732301,  750498, -750498,  732301,
	 963761,  413131, -413131,  963761,  389354,  973609, -973609,  389354,
	1025840,  217172, -217172, 1025840,  571815,  878942, -878942,  571815,
	 864645,  593213, -593213,  864645,  191931, 1030861,-1030861,  191931,
	1042187,  115576, -115576, 1042187,  655213,  818662, -818662,  655213,
	 918626,  505606, -505606,  918626,  292049, 1007084,-1007084,  292049,
	 999614,  316676, -316676,  999614,  482910,  930758, -930758,  482910,
	 802336,  675106, -675106,  802336,   89965, 1044709,-1044709,   89965,
	1046603,   64299,  -64299, 1046603,  694593,  785526, -785526,  694593,
	 942328,  459922, -459922,  942328,  341113,  991541, -991541,  341113,
	1013948,  267246, -267246, 1013948,  527998,  905941, -905941,  527998,
	 834495,  634924, -634924,  834495,  141118, 1039037,-1039037,  141118,
	1035261,  166575, -166575, 1035261,  614254,  849826, -849826,  614254,
	 892711,  550072, -550072,  892711,  242282, 1020201,-1020201,  242282,
	 982871,  365343, -365343,  982871,  436658,  953332, -953332,  436658,
	 768244,  713662, -713662,  768244,   38595, 1047865,-1047865,   38595,
	1047865,   38595,  -38595, 1047865,  713662,  768244, -768244,  713662,
	 953332,  436658, -436658,  953332,  365343,  982871, -982871,  365343,
	1020201,  242282, -242282, 1020201,  550072,  892711, -892711,  550072,
	 849826,  614254, -614254,  849826,  166575, 1035261,-1035261,  166575,
	1039037,  141118, -141118, 1039037,  634924,  834495, -834495,  634924,
	 905941,  527998, -527998,  905941,  267246, 1013948,-1013948,  267246,
	 991541,  341113, -341113,  991541,  459922,  942328, -942328,  459922,
	 785526,  694593, -694593,  785526,   64299, 1046603,-1046603,   64299,
	1044709,   89965,  -89965, 1044709,  675106,  802336, -802336,  675106,
	 930758,  482910, -482910,  930758,  316676,  999614, -999614,  316676,
	1007084,  292049, -292049, 1007084,  505606,  918626, -918626,  505606,
	 818662,  655213, -655213,  818662,  115576, 1042187,-1042187,  115576,
	1030861,  191931, -191931, 1030861,  593213,  864645, -864645,  593213,
	 878942,  571815, -571815,  878942,  217172, 1025840,-1025840,  217172,
	 973609,  389354, -389354,  973609,  413131,  963761, -963761,  413131,
	 750498,  732301, -732301,  750498,   12868, 1048497,-1048497,   12868,
	1048556,    6434,   -6434, 1048556,  736892,  745991, -745991,  736892,
	 966278,  407209, -407209,  966278,  395321,  971202, -971202,  395321,
	1027153,  210873, -210873, 1027153,  577197,  875417, -875417,  577197,
	 868268,  587896, -587896,  868268,  198253, 1029664,-1029664,  198253,
	1042877,  109179, -109179, 1042877,  660224,  814627, -814627,  660224,
	 921711,  499960, -499960,  921711,  298223, 1005273,-1005273,  298223,
	1001538,  310537, -310537, 1001538,  488612,  927777, -927777,  488612,
	 806463,  670171, -670171,  806463,   96374, 1044138,-1044138,   96374,
	1046978,   57876,  -57876, 1046978,  699400,  781250, -781250,  699400,
	 945133,  454132, -454132,  945133,  347190,  989429, -989429,  347190,
	1015569,  261020, -261020, 1015569,  533547,  902684, -902684,  533547,
	 838376,  629792, -629792,  838376,  147491, 1038151,-1038151,  147491,
	1036263,  160219, -160219, 1036263,  619456,  846041, -846041,  619456,
	 896069,  544584, -544584,  896069,  248537, 1018696,-1018696,  248537,
	 985094,  359306, -359306,  985094,  442499,  950634, -950634,  442499,
	 772608,  708935, -708935,  772608,   45024, 1047609,-1047609,   45024,
	1048083,   32165,  -32165, 1048083,  718362,  763850, -763850,  718362,
	 955993,  430800, -430800,  955993,  371367,  980611, -980611,  371367,
	1021669,  236018, -236018, 1021669,  555539,  889319, -889319,  555539,
	 853579,  609028, -609028,  853579,  172924, 1034219,-1034219,  172924,
	1039883,  134740, -134740, 1039883,  640033,  830584, -830584,  640033,
	 909164,  522430, -522430,  909164,  273462, 1012289,-1012289,  273462,
	 993616,  335022, -335022,  993616,  465696,  939489, -939489,  465696,
	 789774,  689760, -689760,  789774,   70720, 1046188,-1046188,   70720,
	1045242,   83553,  -83553, 1045242,  680017,  798179, -798179,  680017,
	 933703,  477190, -477190,  933703,  322804,  997652, -997652,  322804,
	1008857,  285864, -285864, 1008857,  511233,  915506, -915506,  511233,
	 822667,  650177, -650177,  822667,  121969, 1041458,-1041458,  121969,
	1032019,  185602, -185602, 1032019,  598507,  860988, -860988,  598507,
	 882434,  566411, -566411,  882434,  223462, 1024488,-1024488,  223462,
	 975980,  383373, -383373,  975980,  419036,  961208, -961208,  419036,
	 754977,  727682, -727682,  754977,   19301, 1048398,-1048398,   19301,
	1048398,   19301,  -19301, 1048398,  727682,  754977, -754977,  727682,
	 961208,  419036, -419036,  961208,  383373,  975980, -975980,  383373,
	1024488,  223462, -223462, 1024488,  566411,  882434, -882434,  566411,
	 860988,  598507, -598507,  860988,  185602, 1032019,-1032019,  185602,
	1041458,  121969, -121969, 1041458,  650177,  822667, -822667,  650177,
	 915506,  511233, -511233,  915506,  285864, 1008857,-1008857,  285864,
	 997652,  322804, -322804,  997652,  477190,  933703, -933703,  477190,
	 798179,  680017, -680017,  798179,   83553, 1045242,-1045242,   83553,
	1046188,   70720,  -70720, 1046188,  689760,  789774, -789774,  689760,
	 939489,  465696, -465696,  939489,  335022,  993616, -993616,  335022,
	1012289,  273462, -273462, 1012289,  522430,  909164, -909164,  522430,
	 830584,  640033, -640033,  830584,  134740, 1039883,-1039883,  134740,
	1034219,  172924, -172924, 1034219,  609028,  853579, -853579,  609028,
	 889319,  555539, -555539,  889319,  236018, 1021669,-1021669,  236018,
	 980611,  371367, -371367,  980611,  430800,  955993, -955993,  430800,
	 763850,  718362, -718362,  763850,   32165, 1048083,-1048083,   32165,
	1047609,   45024,  -45024, 1047609,  708935,  772608, -772608,  708935,
	 950634,  442499, -442499,  950634,  359306,  985094, -985094,  359306,
	1018696,  248537, -248537, 1018696,  544584,  896069, -896069,  544584,
	 846041,  619456, -619456,  846041,  160219, 1036263,-1036263,  160219,
	1038151,  147491, -147491, 1038151,  629792,  838376, -838376,  629792,
	 902684,  533547, -533547,  902684,  261020, 1015569,-1015569,  261020,
	 989429,  347190, -347190,  989429,  454132,  945133, -945133,  454132,
	 781250,  699400, -699400,  781250,   57876, 1046978,-1046978,   57876,
	1044138,   96374,  -96374, 1044138,  670171,  806463, -806463,  670171,
	 927777,  488612, -488612,  927777,  310537, 1001538,-1001538,  310537,
	1005273,  298223, -298223, 1005273,  499960,  921711, -921711,  499960,
	 814627,  660224, -660224,  814627,  109179, 1042877,-1042877,  109179,
	1029664,  198253, -198253, 1029664,  587896,  868268, -868268,  587896,
	 875417,  577197, -577197,  875417,  210873, 1027153,-1027153,  210873,
	 971202,  395321, -395321,  971202,  407209,  966278, -966278,  407209,
	 745991,  736892, -736892,  745991,    6434, 1048556,-1048556,    6434,
	1048571,    3217,   -3217, 1048571,  739177,  743726, -743726,  739177,
	 967522,  404243, -404243,  967522,  398299,  969984, -969984,  398299,
	1027795,  207721, -207721, 1027795,  579880,  873642, -873642,  579880,
	 870068,  585230, -585230,  870068,  201411, 1029051,-1029051,  201411,
	1043207,  105979, -105979, 1043207,  662720,  812597, -812597,  662720,
	 923241,  497130, -497130,  923241,  301306, 1004354,-1004354,  301306,
	1002486,  307463, -307463, 1002486,  491456,  926274, -926274,  491456,
	 808516,  667693, -667693,  808516,   99576, 1043837,-1043837,   99576,
	1047150,   54664,  -54664, 1047150,  701794,  779100, -779100,  701794,
	 946522,  451230, -451230,  946522,  350224,  988360, -988360,  350224,
	1016365,  257903, -257903, 1016365,  536314,  901043, -901043,  536314,
	 840304,  627217, -627217,  840304,  150675, 1037694,-1037694,  150675,
	1036750,  157039, -157039, 1036750,  622049,  844137, -844137,  622049,
	 897736,  541833, -541833,  897736,  251661, 1017928,-1017928,  251661,
	 986192,  356282, -356282,  986192,  445414,  949272, -949272,  445414,
	 774780,  706561, -706561,  774780,   48238, 1047466,-1047466,   48238,
	1048176,   28949,  -28949, 1048176,  720702,  761643, -761643,  720702,
	 957310,  427865, -427865,  957310,  374374,  979467, -979467,  374374,
	1022388,  232882, -232882, 1022388,  558265,  887610, -887610,  558265,
	 855443,  606406, -606406,  855443,  176096, 1033684,-1033684,  176096,
	1040292,  131549, -131549, 1040292,  642578,  828616, -828616,  642578,
	 910762,  519638, -519638,  910762,  276567, 1011446,-1011446,  276567,
	 994639,  331972, -331972,  994639,  468576,  938056, -938056,  468576,
	 791886,  687334, -687334,  791886,   73929, 1045967,-1045967,   73929,
	1045493,   80346,  -80346, 1045493,  682462,  796089, -796089,  682462,
	 935163,  474323, -474323,  935163,  325863,  996657, -996657,  325863,
	1009730,  282768, -282768, 1009730,  514040,  913934, -913934,  514040,
	 824658,  647650, -647650,  824658,  125163, 1041079,-1041079,  125163,
	1032584,  182435, -182435, 1032584,  601146,  859148, -859148,  601146,
	 884168,  563701, -563701,  884168,  226604, 1023798,-1023798,  226604,
	 977151,  380377, -380377,  977151,  421983,  959918, -959918,  421983,
	 757206,  725362, -725362,  757206,   22517, 1048334,-1048334,   22517,
	1048453,   16084,  -16084, 1048453,  729995,  752741, -752741,  729995,
	 962489,  416085, -416085,  962489,  386365,  974799, -974799,  386365,
	1025169,  220318, -220318, 1025169,  569115,  880692, -880692,  569115,
	 862821,  595863, -595863,  862821,  188768, 1031445,-1031445,  188768,
	1041828,  118773, -118773, 1041828,  652698,  820669, -820669,  652698,
	 917071,  508422, -508422,  917071,  288958, 1007976,-1007976,  288958,
	 998638,  319741, -319741,  998638,  480052,  932235, -932235,  480052,
	 800261,  677565, -677565,  800261,   86759, 1044981,-1044981,   86759,
	1046401,   67510,  -67510, 1046401,  692180,  787654, -787654,  692180,
	 940913,  462811, -462811,  940913,  338069,  992583, -992583,  338069,
	1013124,  270356, -270356, 1013124,  525216,  907557, -907557,  525216,
	 832544,  637482, -637482,  832544,  137930, 1039465,-1039465,  137930,
	1034745,  169750, -169750, 1034745,  611643,  851706, -851706,  611643,
	 891019,  552808, -552808,  891019,  239151, 1020940,-1020940,  239151,
	 981746,  368357, -368357,  981746,  433731,  954667, -954667,  433731,
	 766051,  716015, -716015,  766051,   35380, 1047979,-1047979,   35380,
	1047742,   41810,  -41810, 1047742,  711302,  770430, -770430,  711302,
	 951988,  439581, -439581,  951988,  362326,  983987, -983987,  362326,
	1019453,  245411, -245411, 1019453,  547331,  894394, -894394,  547331,
	 847937,  616858, -616858,  847937,  163398, 1035767,-1035767,  163398,
	1038599,  144305, -144305, 1038599,  632361,  836439, -836439,  632361,
	 904317,  530775, -530775,  904317,  264134, 1014763,-1014763,  264134,
	 990490,  344153, -344153,  990490,  457029,  943735, -943735,  457029,
	 783392,  697000, -697000,  783392,   61088, 1046795,-1046795,   61088,
	1044429,   93170,  -93170, 1044429,  672642,  804403, -804403,  672642,
	 929272,  485763, -485763,  929272,  313608, 1000581,-1000581,  313608,
	1006184,  295137, -295137, 1006184,  502786,  920173, -920173,  502786,
	 816648,  657721, -657721,  816648,  112378, 1042537,-1042537,  112378,
	1030267,  195093, -195093, 1030267,  590557,  866460, -866460,  590557,
	 877184,  574509, -574509,  877184,  214024, 1026502,-1026502,  214024,
	 972410,  392339, -392339,  972410,  410172,  965024, -965024,  410172,
	 748248,  734600, -734600,  748248,    9651, 1048532,-1048532,    9651,
	1048532,    9651,   -9651, 1048532,  734600,  748248, -748248,  734600,
	 965024,  410172, -410172,  965024,  392339,  972410, -972410,  392339,
	1026502,  214024, -214024, 1026502,  574509,  877184, -877184,  574509,
	 866460,  590557, -590557,  866460,  195093, 1030267,-1030267,  195093,
	1042537,  112378, -112378, 1042537,  657721,  816648, -816648,  657721,
	 920173,  502786, -502786,  920173,  295137, 1006184,-1006184,  295137,
	1000581,  313608, -313608, 1000581,  485763,  929272, -929272,  485763,
	 804403,  672642, -672642,  804403,   93170, 1044429,-1044429,   93170,
	1046795,   61088,  -61088, 1046795,  697000,  783392, -783392,  697000,
	 943735,  457029, -457029,  943735,  344153,  990490, -990490,  344153,
	1014763,  264134, -264134, 1014763,  530775,  904317, -904317,  530775,
	 836439,  632361, -632361,  836439,  144305, 1038599,-1038599,  144305,
	1035767,  163398, -163398, 1035767,  616858,  847937, -847937,  616858,
	 894394,  547331, -547331,  894394,  245411, 1019453,-1019453,  245411,
	 983987,  362326, -362326,  983987,  439581,  951988, -951988,  439581,
	 770430,  711302, -711302,  770430,   41810, 1047742,-1047742,   41810,
	1047979,   35380,  -35380, 1047979,  716015,  766051, -766051,  716015,
	 954667,  433731, -433731,  954667,  368357,  981746, -981746,  368357,
	1020940,  239151, -239151, 1020940,  552808,  891019, -891019,  552808,
	 851706,  611643, -611643,  851706,  169750, 1034745,-1034745,  169750,
	1039465,  137930, -137930, 1039465,  637482,  832544, -832544,  637482,
	 907557,  525216, -525216,  907557,  270356, 1013124,-1013124,  270356,
	 992583,  338069, -338069,  992583,  462811,  940913, -940913,  462811,
	 787654,  692180, -692180,  787654,   67510, 1046401,-1046401,   67510,
	1044981,   86759,  -86759, 1044981,  677565,  800261, -800261,  677565,
	 932235,  480052, -480052,  932235,  319741,  998638, -998638,  319741,
	1007976,  288958, -288958, 1007976,  508422,  917071, -917071,  508422,
	 820669,  652698, -652698,  820669,  118773, 1041828,-1041828,  118773,
	1031445,  188768, -188768, 1031445,  595863,  862821, -862821,  595863,
	 880692,  569115, -569115,  880692,  220318, 1025169,-1025169,  220318,
	 974799,  386365, -386365,  974799,  416085,  962489, -962489,  416085,
	 752741,  729995, -729995,  752741,   16084, 1048453,-1048453,   16084,
	1048334,   22517,  -22517, 1048334,  725362,  757206, -757206,  725362,
	 959918,  421983, -421983,  959918,  380377,  977151, -977151,  380377,
	1023798,  226604, -226604, 1023798,  563701,  884168, -884168,  563701,
	 859148,  601146, -601146,  859148,  182435, 1032584,-1032584,  182435,
	1041079,  125163, -125163, 1041079,  647650,  824658, -824658,  647650,
	 913934,  514040, -514040,  913934,  282768, 1009730,-1009730,  282768,
	 996657,  325863, -325863,  996657,  474323,  935163, -935163,  474323,
	 796089,  682462, -682462,  796089,   80346, 1045493,-1045493,   80346,
	1045967,   73929,  -73929, 1045967,  687334,  791886, -791886,  687334,
	 938056,  468576, -468576,  938056,  331972,  994639, -994639,  331972,
	1011446,  276567, -276567, 1011446,  519638,  910762, -910762,  519638,
	 828616,  642578, -642578,  828616,  131549, 1040292,-1040292,  131549,
	1033684,  176096, -176096, 1033684,  606406,  855443, -855443,  606406,
	 887610,  558265, -558265,  887610,  232882, 1022388,-1022388,  232882,
	 979467,  374374, -374374,  979467,  427865,  957310, -957310,  427865,
	 761643,  720702, -720702,  761643,   28949, 1048176,-1048176,   28949,
	1047466,   48238,  -48238, 1047466,  706561,  774780, -774780,  706561,
	 949272,  445414, -445414,  949272,  356282,  986192, -986192,  356282,
	1017928,  251661, -251661, 1017928,  541833,  897736, -897736,  541833,
	 844137,  622049, -622049,  844137,  157039, 1036750,-1036750,  157039,
	1037694,  150675, -150675, 1037694,  627217,  840304, -840304,  627217,
	 901043,  536314, -536314,  901043,  257903, 1016365,-1016365,  257903,
	 988360,  350224, -350224,  988360,  451230,  946522, -946522,  451230,
	 779100,  701794, -701794,  779100,   54664, 1047150,-1047150,   54664,
	1043837,   99576,  -99576, 1043837,  667693,  808516, -808516,  667693,
	 926274,  491456, -491456,  926274,  307463, 1002486,-1002486,  307463,
	1004354,  301306, -301306, 1004354,  497130,  923241, -923241,  497130,
	 812597,  662720, -662720,  812597,  105979, 1043207,-1043207,  105979,
	1029051,  201411, -201411, 1029051,  585230,  870068, -870068,  585230,
	 873642,  579880, -579880,  873642,  207721, 1027795,-1027795,  207721,
	 969984,  398299, -398299,  969984,  404243,  967522, -967522,  404243,
	 743726,  739177, -739177,  743726,    3217, 1048571,-1048571,    3217,
};

fpp ffp_mul(fpp x, int64_t rt)
{
	int64_t alo, ahi;

	ahi = x >> 32;
	alo = x & 0xFFFFFFFF;

	alo = (alo * rt) >> 20;
	ahi = (ahi * rt) << 12;
	return alo + ahi;
}

void
fpp_FFT(fpp *f, unsigned logn)
{
	/*
	 * FFT algorithm in bit-reversal order uses the following
	 * iterative algorithm:
	 *
	 *   t = N
	 *   for m = 1; m < N; m *= 2:
	 *       ht = t/2
	 *       for i1 = 0; i1 < m; i1 ++:
	 *           j1 = i1 * t
	 *           s = GM[m + i1]
	 *           for j = j1; j < (j1 + ht); j ++:
	 *               x = f[j]
	 *               y = s * f[j + ht]
	 *               f[j] = x + y
	 *               f[j + ht] = x - y
	 *       t = ht
	 *
	 * GM[k] contains w^rev(k) for primitive root w = exp(i*pi/N).
	 *
	 * In the description above, f[] is supposed to contain complex
	 * numbers. In our in-memory representation, the real and
	 * imaginary parts of f[k] are in array slots k and k+N/2.
	 *
	 * We only keep the first half of the complex numbers. We can
	 * see that after the first iteration, the first and second halves
	 * of the array of complex numbers have separate lives, so we
	 * simply ignore the second part.
	 */

	unsigned u;
	size_t t, n, hn, m;

	/*
	 * First iteration: compute f[j] + i * f[j+N/2] for all j < N/2
	 * (because GM[1] = w^rev(1) = w^(N/2) = i).
	 * In our chosen representation, this is a no-op: everything is
	 * already where it should be.
	 */

	/*
	 * Subsequent iterations are truncated to use only the first
	 * half of values.
	 */
	n = MKN(logn);
	hn = n >> 1;
	t = hn;

	for (u = 1, m = 2; u < logn; u ++, m <<= 1) {
		size_t ht, hm, i1, j1;

		ht = t >> 1;
		hm = m >> 1;
		for (i1 = 0, j1 = 0; i1 < hm; i1 ++, j1 += t) {
			size_t j, j2;

			j2 = j1 + ht;
			int64_t s_re, s_im;

			s_re = fpp_gm_tab[((m + i1) << 1) + 0];
			s_im = fpp_gm_tab[((m + i1) << 1) + 1];
			for (j = j1; j < j2; j ++) {
				fpp x_re, x_im, y_re, y_im, tmp;

				x_re = f[j];
				x_im = f[j + hn];
				y_re = f[j + ht];
				y_im = f[j + ht + hn];

				tmp  = fpp_sub(ffp_mul(y_re, s_re), ffp_mul(y_im, s_im));
				y_im = fpp_add(ffp_mul(y_re, s_im), ffp_mul(y_im, s_re));
				y_re = tmp;

				f[j      ] = fpp_add(x_re, y_re);
				f[j   +hn] = fpp_add(x_im, y_im);
				f[j+ht   ] = fpp_sub(x_re, y_re);
				f[j+ht+hn] = fpp_sub(x_im, y_im);
			}
		}
		t = ht;

		if (u % 2 == 0) {
			for (j1 = 0; j1 < n; j1++)
				f[j1] >>= 1;
		}
	}
}

void
fpp_iFFT(fpp *f, unsigned logn)
{
	/*
	 * Inverse FFT algorithm in bit-reversal order uses the following
	 * iterative algorithm:
	 *
	 *   t = 1
	 *   for m = N; m > 1; m /= 2:
	 *       hm = m/2
	 *       dt = t*2
	 *       for i1 = 0; i1 < hm; i1 ++:
	 *           j1 = i1 * dt
	 *           s = iGM[hm + i1]
	 *           for j = j1; j < (j1 + t); j ++:
	 *               x = f[j]
	 *               y = f[j + t]
	 *               f[j] = x + y
	 *               f[j + t] = s * (x - y)
	 *       t = dt
	 *   for i1 = 0; i1 < N; i1 ++:
	 *       f[i1] = f[i1] / N
	 *
	 * iGM[k] contains (1/w)^rev(k) for primitive root w = exp(i*pi/N)
	 * (actually, iGM[k] = 1/GM[k] = conj(GM[k])).
	 *
	 * In the main loop (not counting the final division loop), in
	 * all iterations except the last, the first and second half of f[]
	 * (as an array of complex numbers) are separate. In our chosen
	 * representation, we do not keep the second half.
	 *
	 * The last iteration recombines the recomputed half with the
	 * implicit half, and should yield only real numbers since the
	 * target polynomial is real; moreover, s = i at that step.
	 * Thus, when considering x and y:
	 *    y = conj(x) since the final f[j] must be real
	 *    Therefore, f[j] is filled with 2*Re(x), and f[j + t] is
	 *    filled with 2*Im(x).
	 * But we already have Re(x) and Im(x) in array slots j and j+t
	 * in our chosen representation. That last iteration is thus a
	 * simple doubling of the values in all the array.
	 *
	 * We make the last iteration a no-op by tweaking the final
	 * division into a division by N/2, not N.
	 */
	size_t u, n, hn, t, m;

	n = MKN(logn);
	t = 1;
	m = n;
	hn = n >> 1;
	for (u = logn; u > 1; u --) {
		size_t hm, dt, i1, j1;

		hm = m >> 1;
		dt = t << 1;
		for (i1 = 0, j1 = 0; j1 < hn; i1 ++, j1 += dt) {
			size_t j, j2;

			j2 = j1 + t;
			fpp s_re, s_im;

			s_re = fpp_gm_tab[((hm + i1) << 1) + 0];
			s_im = fpp_neg(fpp_gm_tab[((hm + i1) << 1) + 1]);
			for (j = j1; j < j2; j ++) {
				fpp x_re, x_im, y_re, y_im, tmp;

				x_re = f[j];
				x_im = f[j + hn];
				y_re = f[j + t];
				y_im = f[j + t + hn];

				f[j     ] = fpp_add(x_re, y_re);
				f[j + hn] = fpp_add(x_im, y_im);

				x_re = fpp_sub(x_re, y_re);
				x_im = fpp_sub(x_im, y_im);

				tmp = fpp_sub(
					ffp_mul(x_re, s_re), ffp_mul(x_im, s_im));
				f[j + t + hn] = fpp_add(
					ffp_mul(x_re, s_im), ffp_mul(x_im, s_re));
				f[j + t     ] = tmp;
			}
		}
		t = dt;
		m = hm;

		for (j1 = 0; j1 < n; j1++)
			f[j1] >>= 1;
	}

	/*
	 * Last iteration is a no-op, provided that we divide by N/2
	 * instead of N. We need to make a special case for logn = 0.
	 */
	/* if (logn > 0) {
		for (u = 0; u < n; u ++) {
			f[u] >>= logn - 1;
		}
	} */
}
