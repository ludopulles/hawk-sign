/*
 * Hawk signature verification.
 *
 * ==========================(LICENSE BEGIN)============================
 *
 * Copyright (c) 2017-2019  Falcon Project
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 * CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * ===========================(LICENSE END)=============================
 *
 * @author   Thomas Pornin <thomas.pornin@nccgroup.com>
 */

#include <assert.h>
#include "inner.h"

/*
 * The hash of a message has two parts: (h0, h1), where each is a polynomial of
 * length n with coefficients in {0,1}. However, these bits are collected into
 * bytes for saving RAM usage. This function returns the index in the hash
 * array at which the bits start for h1.
 */
#define SECOND_HASH(h, logn) \
	((h) + ((logn) <= 3 ? 1u : 1u << ((logn) - 3)))

/*
 * If s != NULL, set the polynomial p equal to h - 2 * s.
 * Otherwise, set p equal to h.
 * Returns the polynomial in FFT format.
 */
static void
hash_to_fft(fpr *p, const uint8_t *h, const int16_t *s, unsigned logn)
{
	size_t n, u, v;
	uint8_t hash;

	n = MKN(logn);
	if (logn <= 3) {
		for (u = 0; u < n; u ++) {
			p[u] = fpr_of(((h[0] >> u) & 1) - (s == NULL ? 0 : 2 * s[u]));
		}
	} else {
		for (u = 0; u < n; ) {
			hash = *h++;
			for (v = 0; v < 8; v ++, u ++) {
				p[u] = fpr_of((hash & 1) - (s == NULL ? 0 : 2 * s[u]));
				hash >>= 1;
			}
		}
	}
	Zf(FFT)(p, logn);
}

/*
 * Returns whether squared geometric norm of (t0, t1) with respect to Q is at
 * most the specified allowed l2-bound. The t0, t1 are assumed to be in FFT
 * representation.
 */
static int
has_short_trace(const fpr *restrict t0, const fpr *restrict t1,
	const fpr *restrict q00, const fpr *restrict q10, const fpr *restrict q11,
	unsigned logn)
{
	size_t u, hn;
	fpr trace;

	hn = MKN(logn) >> 1;
	trace = fpr_zero;

	/*
	 * Calculate trace( (t0, t1)^* Q (t0, t1) ) / n, and determine if this is
	 * short. The trace of a polynomial in FFT representation is the sum of its
	 * `n` complex embeddings, and since half of the embeddings are stored, we
	 * only need to sum the real value for each pair of complex embeddings.
	 *
	 * Add the contribution of t0 q00 t0*.
	 */
	for (u = 0; u < hn; u ++) {
		fpr norm_t0;

		norm_t0 = fpr_add(fpr_sqr(t0[u]), fpr_sqr(t0[u + hn]));
		trace = fpr_add(trace, fpr_mul(norm_t0, q00[u]));
	}

	/*
	 * Add the contribution of t1 q11 t1*.
	 */
	for (u = 0; u < hn; u ++) {
		fpr norm_t1;

		norm_t1 = fpr_add(fpr_sqr(t1[u]), fpr_sqr(t1[u + hn]));
		trace = fpr_add(trace, fpr_mul(norm_t1, q11[u]));
	}

	/*
	 * Add the contribution of t1 q10 t0* + t0 q01 t1*.
	 */
	for (u = 0; u < hn; u ++) {
		fpr re, im;

		// t0* t1
		re = fpr_add(fpr_mul(t0[u], t1[u]), fpr_mul(t0[u + hn], t1[u + hn]));
		im = fpr_sub(fpr_mul(t0[u], t1[u + hn]), fpr_mul(t0[u + hn], t1[u]));

		trace = fpr_add(trace, fpr_double(
			fpr_sub(fpr_mul(re, q10[u]), fpr_mul(im, q10[u + hn]))
		));
	}

	/*
	 * Renormalize to obtain the squared geometric norm of (t0, t1) w.r.t Q.
	 */
	trace = fpr_div(trace, fpr_of(hn));

	/*
	 * Check whether the norm is in range [0, 2^31). Signature is valid iff
	 * squared norm of (t0, t1) w.r.t. Q is at most bound.
	 */
	return !fpr_lt(trace, fpr_zero)
		&& fpr_lt(trace, fpr_ptwo31m1)
		&& (uint32_t)fpr_rint(trace) <= L2BOUND(logn);
}

/* =================================================================== */

/* see inner.h */
void
Zf(complete_pubkey)(const int16_t *restrict iq00, const int16_t *restrict iq10,
	fpr *restrict q00, fpr *restrict q10, fpr *restrict q11, unsigned logn)
{
	size_t u, hn;

	hn = MKN(logn - 1);

	/*
	 * Doing this in reverse, allows iq00, iq10 to overlap with the begin of
	 * q00.
	 */
	Zf(int16_to_fft)(q10, iq10, logn);
	Zf(int16_to_fft)(q00, iq00, logn);

	/*
	 * Reconstruct q11 using q11 = (1 + q10 adj(q10)) / q00.
	 */
	Zf(poly_prod_selfadj_fft)(q11, q10, logn);
	for (u = 0; u < hn; u ++) {
		q11[u] = fpr_add(q11[u], fpr_one);
	}
	Zf(poly_div_autoadj_fft)(q11, q00, logn);
}

/* see inner.h */
int
Zf(uncompressed_verify)(const uint8_t *restrict h,
	const int16_t *restrict s0, const int16_t *restrict s1,
	const fpr *restrict q00, const fpr *restrict q10, const fpr *restrict q11,
	unsigned logn, uint8_t *restrict tmp)
{
	size_t n;
	fpr *t0, *t1;

	n = MKN(logn);
	t0 = (fpr *)tmp;
	t1 = t0 + n;

	/*
	 * Put (t0, t1) = (h0 - 2 s0, h1 - 2 s1) in FFT representation.
	 */
	hash_to_fft(t0, h, s0, logn);
	hash_to_fft(t1, SECOND_HASH(h, logn), s1, logn);

	return Zf(in_positive_half)(s1, SECOND_HASH(h, logn), logn)
		&& has_short_trace(t0, t1, q00, q10, q11, logn);
}

/* see inner.h */
int
Zf(recover_and_verify)(const uint8_t *restrict h,
	int16_t *restrict s0, const int16_t *restrict s1,
	const fpr *restrict q00, const fpr *restrict q10, const fpr *restrict q11,
	unsigned logn, uint8_t *restrict tmp)
{
	size_t n, u, v, w;
	uint8_t h0;
	fpr *t0, *t1;

	n = MKN(logn);
	t0 = (fpr *)tmp;
	t1 = t0 + n;

	hash_to_fft(t1, SECOND_HASH(h, logn), s1, logn);
	memcpy(t0, t1, n * sizeof *t1);
	Zf(poly_mul_fft)(t0, q10, logn);
	Zf(poly_div_autoadj_fft)(t0, q00, logn);
	Zf(iFFT)(t0, logn);

	/*
	 * Recover s0 with s0 = round(h0 / 2 + (h1 / 2 - s1) q10 / q00).
	 * Put (t0, t1) = (h0 - 2 * s0, h1 - 2 * s1) in FFT representation.
	 */
	if (logn <= 3) {
		h0 = h[0];
		for (u = 0; u < n; u ++) {
			s0[u] = fpr_rint(fpr_half(fpr_add(fpr_of(h0 & 1), t0[u])));
			h0 >>= 1;
		}
	} else {
		for (u = 0, w = 0; w < n; u ++) {
			h0 = h[u];
			for (v = 0; v < 8; v ++, w ++) {
				s0[w] = fpr_rint(fpr_half(fpr_add(fpr_of(h0 & 1), t0[w])));
				h0 >>= 1;
			}
		}
	}

	hash_to_fft(t0, h, s0, logn);
	return Zf(in_positive_half)(s1, SECOND_HASH(h, logn), logn)
		&& has_short_trace(t0, t1, q00, q10, q11, logn);
}

/* see inner.h */
int
Zf(verify_nearest_plane)(const uint8_t *restrict h,
	int16_t *restrict s0, const int16_t *restrict s1,
	const fpr *restrict q00, const fpr *restrict q10, const fpr *restrict q11,
	unsigned logn, uint8_t *restrict tmp)
{
	/*
	 * This works slightly better than simple rounding, but is also slower.
	 * Reconstruct s0, by running Babai's NP algorithm with target
	 *     h0 / 2 + (h1 / 2 - s1) * q10 / q00.
	 */

	size_t n;
	fpr *t0, *t1;

	n = MKN(logn);
	t0 = (fpr *)tmp;
	t1 = t0 + n;

	hash_to_fft(t0, h, NULL, logn);
	hash_to_fft(t1, SECOND_HASH(h, logn), s1, logn);

	Zf(poly_mul_fft)(t1, q10, logn);
	Zf(poly_div_autoadj_fft)(t1, q00, logn);
	Zf(poly_add)(t0, t1, logn);
	Zf(poly_mulconst)(t0, fpr_onehalf, logn);

	memcpy(t1, q00, n * sizeof *q00);
	/*
	 * Run Babai with target t0 and Gram-matrix q00.
	 */
	Zf(ffNearestPlane_dyn)(t0, t1, logn, t1 + n);
	Zf(fft_to_int16)(s0, t0, logn);

	/*
	 * Now run the casual verification.
	 */
	return Zf(in_positive_half)(s1, SECOND_HASH(h, logn), logn)
		&& Zf(uncompressed_verify)(h, s0, s1, q00, q10, q11, logn, tmp);
}

/* see inner.h */
int
Zf(verify)(const uint8_t *restrict h, const int16_t *restrict s1,
	const fpr *restrict q00, const fpr *restrict q10, const fpr *restrict q11,
	unsigned logn, uint8_t *restrict tmp)
{
	size_t u, v, w, n;
	uint8_t h0;
	int16_t s0w;
	fpr *t0, *t1;

	n = MKN(logn);
	t0 = (fpr *)tmp;
	t1 = t0 + n;

	hash_to_fft(t1, SECOND_HASH(h, logn), s1, logn);
	Zf(poly_prod_fft)(t0, t1, q10, logn);
	Zf(poly_div_autoadj_fft)(t0, q00, logn);
	Zf(iFFT)(t0, logn);

	/*
	 * Recover s0 with s0 = round(h0 / 2 + (h1 / 2 - s1) q10 / q00).
	 * Put (t0, t1) = (h0 - 2 * s0, h1 - 2 * s1) in FFT representation.
	 */
	if (logn <= 3) {
		h0 = h[0];
		for (u = 0; u < n; u ++) {
			s0w = fpr_rint(fpr_half(fpr_add(fpr_of(h0 & 1), t0[u])));
			t0[u] = fpr_of((h0 & 1) - 2 * s0w);
			h0 >>= 1;
		}
	} else {
		for (u = 0, w = 0; w < n; u ++) {
			h0 = h[u];
			for (v = 0; v < 8; v ++, w ++) {
				s0w = fpr_rint(fpr_half(fpr_add(fpr_of(h0 & 1), t0[w])));
				t0[w] = fpr_of((h0 & 1) - 2 * s0w);
				h0 >>= 1;
			}
		}
	}
	Zf(FFT)(t0, logn);

	return Zf(in_positive_half)(s1, SECOND_HASH(h, logn), logn)
		&& has_short_trace(t0, t1, q00, q10, q11, logn);
}

/* ============================================================================
 * Below is all the code necessary for Zf(uncompressed_verify_NTT).
 * Note that a lot of it is duplicate code with the code in keygen.c
 * ==========================================================================*/

/*
 * Two primes < 2^31 that are 1 mod 2048, together with all the powers of some
 * element g of order 2048 (g^{1024} = -1). Then we have
 *   vrfy_gms[j][rev(i)] = g^i mod PRIMES[j]
 *   vrfy_igms[j][rev(i)] = (1/g)^i mod PRIMES[j]
 */

static const uint32_t PRIMES[] = { 2147473409, 2147389441 };

static const uint32_t vrfy_gms[2][1024] = { {
	     10239,1211775442, 844192849, 380966363,1642906936, 510722630,1508861108, 414755385,
	2109245776,1087146993, 713248495,1265826808,1080677998,1362297708, 861384770,1704046399,
	1525826314,2040346214,1008798542, 990045356, 425657146, 940916659, 525355434,1220144974,
	1518429642, 360342609, 681555054,1221091429, 753617555,1505582374,1781626431,1362355089,
	1751781058,1503670474, 247865603, 173865709,2110353619,2131459573, 127447701, 239114940,
	 617267406, 448749591, 384326230,1906564718,2106221345, 179473382,1380314908,2102561211,
	 432785183, 801628975,1120628948,1851439414,1288857789,2082055088,1081533174,1031624451,
	 104130137,  20414221, 432819833, 923335543,1338759613, 892318286,1290891920,1017364761,
	  36002698, 708509534, 380358518,1823310344, 537363935,1884620748, 450654243,2025447014,
	 687149602,1854557834,1149922960,1200308092, 942920061,1671455730,1248242243,1371440516,
	 468712057, 837742417, 504714649, 384570634,1382731462, 181209260,1827372862,1922327559,
	 442440464,1740218200,1006242358, 658351655, 192913844, 989789164, 168046222, 611037314,
	2107895877,1768476110, 307090968, 497786428,1602042887,2041925558,1023900675, 363276096,
	1436075093,2018884887,1390973648,1516682538,1632629963, 303454174,  79134887,1248255805,
	  58583500,1427266261,1584996579,1138827852,1359849367, 916439405, 773485398, 700527161,
	1375775427,1311749239, 400642350, 113272554,1776843222, 180652410, 920139840,1859785964,
	 583466347,1509557675, 177601563, 763519245,1533806043,1475595655,1633744151,1699146609,
	1279358270,1140596582,1743446655,1950486424,2002106984,1983766627,1387245836,1160495532,
	1205311157,1686430386, 823547732, 894518914, 618678643,1285853906,2085085575, 996621102,
	1309910078, 368160411,1785021856,1017356205, 760557546,  29755780,1190278574,1609255884,
	1142758706,1366333934,2105509705,1121405167,  61391092, 620605334,1542407506,1085515179,
	1945940088,1452139808,  13813379,1909217707,1496258546, 847505541,1219276327,1787224466,
	1162609347,  85865205, 447467939, 294851667, 184347772,2146747604,2073092060,1886341010,
	 519009783, 867911298,1803216637, 268350358,1101300331,  16822795,1720513678,1333415557,
	 898194720,1340148490,1499505520, 219811299, 350693271,1187228969, 950248169, 679803024,
	1723992616, 939272158, 958873850,1683351501,1432100077, 940544688,1104107542, 808551866,
	2055916433,2108664100,1127573735, 343373448,1267991536, 122094490, 464575848, 311020792,
	 207069494,1346874562, 520565008,1840397553, 916905168,1774333560,2027728486, 525894281,
	1784779199, 107024725,1093245612,1026561681,1062183198, 266560742,2053687302,1233408762,
	1682728276,1063355365, 139739751,2110386679,  73184363, 328292696, 895887944,1006535118,
	1632685417,1802335891, 407686578, 182731865, 831113830, 253522177,1652724996,1261362198,
	 614950335, 558670853,1180201267, 709957599,2139950168,1909331767, 855761909,1536726149,
	1685737800,1302873836,1041680072, 889516160,1404722186,1300563552, 328646981,1879613112,
	1844665594, 834002180, 532194333, 798202943, 654418938, 645421153,1261736554, 795603364,
	 344373277,1568798590, 667610339,1002497615,1630248637, 293661843,1600425477,2039099976,
	1165855232, 509675689,1014006046, 560778883,1728146825,1975446215,1801856698,1371798373,
	  61649618,1680383894,1420154200, 288536768, 454519824, 588661843,1118624769, 173283048,
	 510699217,  11799381, 576276296, 785108592,1638761230, 461574555, 613363350,2085064234,
	 162811327,  22632813,1594550151, 968274199,1402225082, 512621188,1935621155, 305433610,
	1189149610,1041848618,1678938226,  22251669,1505833074,1856089363,  55210454, 617049291,
	 152195421,1482969307, 121223257, 175400221, 788561804,1409092199, 208373922,1503150719,
	 905590624,2099339924,1726934526, 490608969, 971666502, 150104524,1884317549,1421975104,
	1531714930,1110780464, 893166854, 384549288,1757141371,1386909056, 944517816,1767001745,
	1506786929,2004774561,1132145874,   8380668,2045124963, 493622326,2136681329,1383700548,
	 642551345, 964498321,1744724561,  98170524,1585526738,1298626778,1929937396, 645986051,
	 655675705,1949547929,1978909183,1787469359, 999335529,1142896676, 769526595, 340667763,
	 957044362,2042257511, 730865626, 774771027,2102485675, 171632797,1766751439,1979273789,
	  36666292, 483581391,1833884187,1338192126,1881166021, 383585472, 589382997, 844680110,
	1358741468,1527436901,2023093493,1204593935,1234309230, 995377884, 609150156,1918233646,
	1613029282, 297689203,1072050590, 941704499,1119073868,1961565949, 958050648,1779389539,
	1251288897,1440172381,1527064746, 926218156,1913426083, 835556968,2094988831, 268288252,
	 248951729,2132524997,1836682591,1538970563,2035990733, 505016120, 429156433,1414765618,
	1475625721, 943502531, 942683809,1486431004, 523949165,1709054852,1093786037, 526303415,
	 787395686,1721890143,1961248854,1426215768,2024351318,1299811644,1744583208, 457317115,
	1714246102, 613963714,   3700252,1112795255, 700403603, 786047345, 600360113,1724025288,
	 565415073, 505826083,1803513464,1976937507,1637148899,1724912236,2069945137,1092818207,
	 251998493,1097228336,1538816592,2133868705, 124643804, 272277114, 825568049, 139405696,
	1095650222,2121035987,  68383975,1212527119, 940452957,1016776283,  43365217,1534506805,
	1348349006,1663066396,1740016550, 913078586, 575133817,1352735334,2068731429,1528506771,
	1983722035,1843932940,2075871574,2115592672, 139900558,  83743532, 135868355, 414304944,
	1223735551, 871553673, 446423338, 322738569, 482700819,1508906690,1581592256, 361544862,
	 135694878,1147006211, 337625411, 846861313,1331308355,2120754512,   9713916,1825040095,
	1390206652, 210413382,2125294502, 519967958,1720727124,1336818308,1686041362, 424682161,
	1568468320,1875747113,1464045068,2091952259,1828635022,1653477756,1280527114,1853658409,
	1968792473, 601398917,1132237830, 572335236,1736803413, 998090403,2064361528, 307011975,
	1911421248,1368388506, 454592615,1793687542,1146901776,2024249291,  41181831, 312344100,
	 676922102, 625169382,1267896343,1825880845,1228772729,1449330875,1508530636,  15922056,
	 729252878, 405679794, 273764448, 831376914, 623562526, 884538921, 621826379, 596292293,
	1995582791, 684243436, 687523601, 896910770, 622121577,2138515486, 159743608, 922969595,
	1595104654, 944727816, 333787879,1031211337,1997488014, 407284061,1528316051, 474216475,
	1586436886,1682011672, 832836475, 218797698,1824060900,1548663944, 539492781, 360557475,
	1800786486,1453636396, 523069489, 391874117,2068020798,1636189101, 614256898,1378239567,
	  79200507, 748044362, 309088755,2140104334,1559155553,1865792554, 627832514,1595567198,
	  89315992, 563238059,1957040581, 753467359, 472502743, 259040379,2034063691, 416404452,
	1517134842,1222933211,1782541942,1059536659,1802473242, 340156123,2112296092, 284093981,
	 316178045,1650529998,1424521788,  87363732, 219107362, 454531548, 541941034, 964641620,
	 214165283, 951524190, 816965566, 615149116, 419253916, 699914672,1974100984, 557035399,
	 369770014, 754957505,1219481381, 743750305,1278429392, 351174371,1446452342,1670293817,
	1808263263, 743213622,  70951646, 225803398, 316522708, 259632654, 501564200, 737740770,
	1116058501,1564309019,1863616279, 697465394, 808452557,2006458495,1347651787, 459092780,
	 294871957,1090775116,1373753670,1682510517,1198977170, 152500606, 249004218,   6543534,
	1350751910,1646017987, 372361508,1026606845,2061946490, 366223620, 553848712, 100285293,
	1222647857, 164634924,1520228377,1725184997,1943212908, 457358387, 508117577, 521078506,
	 550187930, 515012039,1493066980,  38853673,1981955462,1129763162,1840305085,1164903522,
	1383861961,1546063272,2038625878,  49802431,1742987600, 248830716, 215452565,1124550164,
	 358970387, 810278662,1017455780, 126529700, 551038382, 235795751,1495797364, 815081456,
	 605036630,1987694228,1664977678, 737556278, 600124015,1281844671, 266442612,1111014282,
	1142985306,1241910505,1625569928, 399356465, 142867422, 747939530,1600303628,1400267995,
	1771296899,1055258873,2052928912,1090787526, 372964345, 362927208,1091927141, 432741548,
	 316370380,1835246978, 433897481,  82254432,1992690074,1944916782, 118846818, 664699758,
	1988643670,  65853134,1626822455, 333172150, 725381383, 562213096, 506016833, 299810586,
	 118525426, 303337374, 171327776,  26713826,2019537437, 521306279,1199312441,1504153942,
	 149783903, 572842664,1208201313,2038801298,1936840969,1917068310, 369758600, 989296711,
	1512551716, 981629617,2085868734, 204379666,2006546354,1674395336, 184179730,  64989735,
	 216949439,1405692371, 479925496, 877152322,1936628869, 781626880, 922285903,1441486284,
	 204004983,1910421272,1078812488,1352599241,1424876035,1015933921, 631003086, 200854305,
	1823164499,1762425506, 319476775, 162683438,1372643149, 340974367,1898947515, 127367168,
	1947428753, 645771770,1644249909, 545805129, 196314747,1927973001,2124935557,1021791326,
	1958204163, 240999256,1567760415, 861815805, 222139591, 639931839, 317932896, 965877355,
	1447020149,1380001797, 646585246,1981932492, 663532681,1697718565,1195820371,1375823134,
	1931600886,  63233259,1575314303, 362001141, 748554342, 629977843, 439604348,1733840244,
	2033987436, 672880374,2109196412,2108534276,1748393598,1558708441,1497730436, 902561816,
	 516236031,2116949179,1680500329,1697163516, 418982956,2107611671, 312576069,1118310174,
	1922031495, 753857816, 940780498,1080683561, 274726633,1712130342, 988187652, 170230212,
	 295907756,1397878742,1155365535, 432062235, 352391100, 255435148,1243923685,1834074872,
	1649942772,1680778438, 237681157,1905824844, 313707335, 212325352,1932012258,1415566564,
	2102610109, 635475325, 927021013,1685615242,2002112026,1122406791, 599704611,1126195848,
	1867097811, 936037270,  58489307,1489098433, 898930788,2026853100,1399996178, 443605152,
	1926908365, 419386773, 965194769, 803024130,1835872967,1858960871,1194983444, 224414329,
	1274447749, 814702687,1523027357,2079704210,  76982505, 546638809,1783664192, 371771357,
	1410401016,1702401800,1636708334,1081059658,1156900209,  65075822, 233514419, 776558131,
	 646854602, 742630529,1960648935,1735353162, 793046056,1566379973,1785037788, 378316154,
	1623158941,2046867185, 904735813,1304568919,1085855983, 540414288,   7274646, 904450306,
	1369750803, 298848800,1495928357,1747074847,1529518256,1829891069,1113160993,1635689490,
	 206765130, 161790346, 758724588,2027518062, 194120787,1880179270, 315306206,1679480825,
	1749762293,1479988889,1058424779,1613439111,1538486362,1024151346,1698191548,1653754367,
	1428600388,1612090301, 904428853,1693361054,2076676992,1567754993, 255132195, 777827475,
	1965894978,1362247682, 982762236,1611194546,1501940668, 577062012, 472172169, 727762708,
	 609697494,  12095470,1834931851,2038375771, 487876930, 246483965,1389889743,1552655655,
	1369071755,2065876994,1691311821,2034922378,2145486251, 926245675, 539586486,1838729797,
	1268928391, 266846482, 271595736,1795958107, 845111775,1138779333, 752208778, 967167055,
	1191834611,  54480127,1759311590,2047429647,1275547582, 257925953, 399506788,1304256361,
	 334295217, 379038211,1954294368, 792901565,1236319226,1452336121,1393585513,2006023849,
	1593021737, 977954576, 457092625, 434323556, 697849388,1307987755, 774239444, 399511181,
	1828103853,1283750689,1015686530, 159313948, 622276755,  70904888,2107757872,1947504257,
	 715972420, 765466287,1327423332, 575380119, 765641407, 451336159,1055124865,1592222182,
	1218023510,1835656610, 475930307, 170836896, 712535461, 463687662,1261089329,1422738200,
	2015392116, 903005181, 840388835,1935832642,1597551736, 729216766, 580629496, 680653672
},
{
	     94207, 400422199, 918149158,1732186338, 890097191,1908032154,2012143903,1314999024,
	 768269550, 120439413,2110162196, 753896591, 194443475, 272006360, 311985717,1842452205,
	1355772845,1013164622,1658313873,1058109235,1951533473,1331860926,2140780872, 637371358,
	   5078258,1510792726,1647184740, 350033868,1853684716, 236479419, 928581927, 215496644,
	 777332257,1637600958,1473989850, 915508769,2116329618,1668881923, 458924143,1445669831,
	 646000646,1867342027,1982157506, 183181802,1615018298,1666230622,1694090563, 704186162,
	 308750155, 541144943,1079156044,  76558378, 960437581, 445751722,1789812857,1570072554,
	1356872971,1001829473, 249431925, 711677963, 957708259,1094257223,1387599023,1015649920,
	 341527080, 322162957,1323533792,1742047911,1651507177,1571123561,2089814618,2069939687,
	 107613333,  17404184, 954841997, 444757577, 651039152,1840049657,1756703067,1874553895,
	1011150596, 793645023, 968810421,1218585503,1184933424, 234401771, 259215574, 147383878,
	 749820062,  68831734,1880978002, 361662637,1246895154,1333779391,1853753941,1701868921,
	 210127707,1022572884, 222881979,2052334436, 544948656,1985587500, 667721237, 314460127,
	 139682403,1270842370,1556037879, 355753537, 845024933, 603230898,1300539833, 275654816,
	 944853738,  90632598,1489197801,1076389822,1589273704,  31478881, 340049523, 612562925,
	 959185075,1747540312,1950648285, 906235654,1187219007,1370292185,1572671194, 291508769,
	1794111345, 662697761,1571570472,1453090445,1167780904,1871440199,1620040980, 126060024,
	 808875158,2021927029,1648393170,1791050607,1801907524,1351794793,1672194455, 428423008,
	 971816081, 966008051,1959459690,2076099697, 808880060,1230166156,1185164224, 105638953,
	1369591281, 709293839, 601256666, 606824944,1315939402,  25983549, 697553155,1523696372,
	 283542340, 895197696,1035587659,1464163216, 876202908, 346818681,1443767615,1399047890,
	 151441743,  74339789,1529538215,1352352874, 168187084,2025651145, 307813157,1318789588,
	1016194477,1536991006,1440981473,1815388481,1752369662,1615450650, 633714420,1247359660,
	 571560717, 793289120,  73430776,1839942674,1062493838, 524266389,1612327741,1632238018,
	 344974679, 534067675, 215855314,1611006179,1717853326, 740468111,  90120793, 210708830,
	1144103784,2031276243,  61946780,1942297191, 351791275,1610255248,1263114190, 963421843,
	 523906400, 294639884, 728878896,1697204758,1893346334,1248344816,1141837594, 532070865,
	1516920468, 140822631,1103654492,  77638171,  14513228,1236467495,1270543013, 289834480,
	 105372986,2085995083, 753987508, 193670244,1273797728, 811880709,1745422880,2124481935,
	1307155087,2052972184, 614443431,1602911585, 390180199,1969919965, 450446197,1702935578,
	1287051470, 737341985,  65542597,2043264120,1588042698, 121042001,1143997474,2012617888,
	1623768656, 136548225,2136899266,2004729597,2129540935, 765289994, 284145857,  65992920,
	1575442798,1897396213, 465780212,1885336010,2025389266,1669942149,1069889475, 261566506,
	1362768743,  54027134,2045614329,1463659351,  93783565, 616620053, 913457324, 165392661,
	 174578710,   5636784,2117899037,1696382360,1894993086, 222590933,1393805962, 690363981,
	1816367160,1401034211, 807928737,1741796539,1366013270, 205647734,2016507755,1704176775,
	1363941517, 756762661, 558131963, 943360084,1043263858,1616918097, 647015770, 721844086,
	 642506616, 450983676, 601618629,1543468183,1680703040, 204510734,2095381181,1602771034,
	1515389815, 246775694,1268478965, 191782684,1272313296, 416216194, 410024213, 442887030,
	  68831898,2075487257,1635825217,1465516014,2117928102,1560795281, 605862409,1487386558,
	1700749605, 957474471, 443930896,1032813036,2057609916,1678032958,1836489175,  47321728,
	1997965088, 421125406,2017104546,1511887965, 874499639,1423958254,1943381980, 662614334,
	  80469449,1690124488,2028109522,1360809963, 944519807,  64444628,1287985037, 625571649,
	 293407683,1565684400,1125536485,1793458274,1561316943,1882802152, 522992147,   4601691,
	1766178178, 582461396, 754135907,1747490972, 459394821,2050632376, 552973592,1930998915,
	1569101033,1492648852,1866756542,1657485199, 775159059,1251539446,1209529504,1516488147,
	1228687881,2012974352, 515412071, 316031141, 879396846,1589918279,1556120643, 671249189,
	 115722933, 171184349, 396479220,1091174487,1118262628, 343622223,1071737819, 667976624,
	1555938540,2048493869, 128869229, 829202502,1117245431,  16933066, 258226828,1179951366,
	1045391554, 789094348,1189018681,1085019366, 576212928, 857672137,1815100402,1874371356,
	 929037920,1004220544,1982796696,1079098877, 215798949,1138448251,1104822422,1654759959,
	1445578362,2078518949,1111080707,1612590440,1394148960,1193130241, 684929972,1305826455,
	1731819221,1613939793, 230095190,1596022620,1173475009, 569397273,1269294243, 693813130,
	1067932101, 848814427,1092283662, 413361118, 693205692,1971323859,1472805838,2048938763,
	 740230671, 503201376, 131815250,  30976956,1919064101,1689961335, 532934561, 581457665,
	1146738730, 519451522, 170890488,1034662222, 413025021, 979251322, 233959215,1692352197,
	  18363526,1548439493, 832611267, 296998315,1197024186, 451036929, 791053548, 154108642,
	1609461578, 161148509,1494491235, 934264986,1975194204, 335219644,1807047762, 226950987,
	1872091027,  16807059, 958019357,1248238344,  75250401,1245788989,1450165137,  77348769,
	 944257318, 219055682, 804101960,  60702088,2126849907, 800801374,1059151595,1415555939,
	 648525313,  88215734, 853606794, 284920841,1245601051, 986769801, 839347252,1236933063,
	 761245120, 197312922, 968885618, 972928995, 600725917,1284378710, 419170659,1146876491,
	1997948418,  72589350, 770377445,1740428584,1433879279,1294853438,1474681804,1671009455,
	 339461060,1709626851, 306416743,2059029159,1395608526, 671623394,1256356143,  64861488,
	 338827563,1222836158,1771403778, 142004765, 150129363, 199513359, 191255166, 901866449,
	1287593193,1846121960,1710474405, 232467942, 129185999,1436441828,1954418128,1674428188,
	  90979586,1909813357,  13078390,1738075146,2014252279, 288053056, 569714495,1040295366,
	1484848354,1807671503,  55039073,1321873883,1083318718,1844783802,1224266201,1362569754,
	1175341923,1217216545,1076741034,1384996009,1634492108, 569106855, 165794867, 631683599,
	1970240092,1445059837,1712171606,1988429616,1783153018,1662355683,2022851108, 816850512,
	1123728699,1333568495, 132613167,1125335274,  53498971, 629204491,1205144758, 759247625,
	1198769265, 881842680, 450395834, 376595939,1913308730,1979769370, 249423004,1257614748,
	  76176054, 893065770,1765869018,1264062189,1951717413,2127274254,1218642669, 274593048,
	1299414747,2123777050,1303457935, 579148844,1394105606, 373508664,1571661490, 272457350,
	 770124241,2015744215,1229284352, 550294303, 991337139,2015072492,1410583564,1209247023,
	1056498328,1855924256, 759387740, 987540418,1740022841,2049842333,1179664195, 944436755,
	1427077257,1802022318, 211955392,1691887157,1901168939, 189789056,  37547404,1423121513,
	 990183947, 551835594,1471652988, 480523445,1754640480,2080657249, 835830384, 163388720,
	 736916417,1577258236,1878709285, 594004225,  94947419, 533854529, 883062309, 942200414,
	 915453063,1065589108,2032736290,2129622553, 348274714,1936678484,1285398587, 433813702,
	 476827454,1670372478, 635478547,1119563493,1043123507, 124703831,1617823213,1780488043,
	 950974637,2039636513, 353077669,1490014582,1081661269,1626907224,1350578062, 703878428,
	 972060587, 665734635,1261114777,  12688262,2049126944, 328974844,1165986774,1242858951,
	1849542458,1783717279,1160977778,1324212938, 228732584, 515975504, 409097427,1847290855,
	 473786350, 227864257, 270393173, 442001719,  89346518,1992236860, 434907185, 495092774,
	 527774598,1744753141, 356946396, 805859802,1939978118, 260937522, 482888170,1558280025,
	 550450400, 405876741,1283162208,1935096213,  30288272, 216746692, 967788940,1305230474,
	1594638449, 549964864,1781261877,1822195922,1007700063, 918957950, 650553277, 245178261,
	1728885894,1095175825, 518882406, 706246340,1650199450,1734583508,1234395273,  90619452,
	 219828512,1435727418,1604981427, 703048094, 846311955,1821911214, 199752087, 648435967,
	1547326933, 865823778, 844746561, 493776172, 836710163,2139473243, 516984969, 190324371,
	2036610880, 986053340,1226839710,1038488793,2145504461, 198997263,  41485916,1743304102,
	1678418010,1485464716,1621566380,  15650132,1229478761,1227864078, 986567762,1942851365,
	1079004195, 864646992, 328442459,1555222785, 915860383, 862164697, 736964844,1552529730,
	1067326381,1501595505, 168955696, 692261032, 235354650, 964363383, 340816288,1831335400,
	 145132231, 299109038,2111541530, 117715710, 156966247,1076662503, 950061387,1993681114,
	 515741068, 792201916, 229034180,1721077366,1173355498, 479037369, 164752955, 195317298,
	 386425872, 498686475, 951196203, 455912153, 103735453, 916994197, 582317429,1068474692,
	 750244726, 433628253, 521512062,1210597020,1402513975,1333462990,1849288015, 368031585,
	 917524655, 137021677,1507002423, 809794683,1791682782, 287264536,2067867596,1830285149,
	 794811785, 975408356, 893239511,2110291195, 249449882,1116493005, 463170864, 321863473,
	 861901977,1871590165,2049835711,   7671846, 981557678,1140698245,1038421283, 861636713,
	 368990331, 957011338,1163642225,1112443153,1780184139,1516089224, 754399728,1861360632,
	  86964179,1415651431, 868423531, 342397515, 181808540,1232117989, 993367303,2047993343,
	 231971939, 186146609, 316773679,1511019915,1238412207,1057006433, 277601244,1993407917,
	 203776526, 976932741,1636646986, 699663568, 415792396, 633243467, 150496580,1956565032,
	 219178518,  32325228, 967562704,1863827818,1890868520, 686412610, 809444913,1893772832,
	1286543572, 942505403,1382520553, 461661655,2112820885, 780882124,1905514466, 538482865,
	 791386842,  87368949, 364622117,1758625755,1402784032, 408566260,1580337115,1796824006,
	1848015827, 288570363, 101144221, 651275437,   2849847,  71847088,2052259812,1579535497,
	1521717620,1868101760,  87153510,1005202705,1767218973,  94007896, 336470084, 962491343,
	 718494052,1585454026,1565023001,1308361837,1871953269,1255894614,1019688683, 538349849,
	 708582111, 879519878, 570030760,1890746839, 219218955,  28615648, 358233959,1092133577,
	1176957856,1456691718,2080510333,2062292606, 130027970,1163564476, 161129292, 633632760,
	1467396009,2096806731,1384071829, 781998831,1395244041,1251506264,2085042601,1717090683,
	 430488856, 471758138, 550035636,1630282121,1400517293,1903712347,1696294707, 376179285,
	 611275931,1961410132,  43306108,2104980637,1235095851, 617563501,1982194800,1773959702,
	 958343032,1251417011,1456162048,1630096336,1834681827, 507587733,1814770800,1647050986,
	1688888528,1319159904,1333603103,1305657432, 172492772, 712321776, 440469020,1067561158,
	 878496183, 963118712,1291769206, 328340609,1399911142, 905830553, 409800403, 607013502,
	 429073494,1764961369, 510609498,1084739208, 499014410,1094474557, 896062791, 544865702,
	1683279108, 638050316,1215614694, 282175164,1682739885,1535703332,1343399249,1883505164,
	1772951617, 527285502, 447649894, 158260024,1103151822,1362362703, 437212452, 349357328,
	 295831465, 535718976,1089795334,1904460178, 189675978, 952741759,1170303972, 998477639,
	1709623025, 133945424, 564063328, 866234426, 578442630,1321924299,1541229436,1376760142,
	 414356421,1070114745,1436029740, 686652864,1781083724, 829339970,2018651034,1157333580,
	1804960621, 700829701,2038551535, 869040097,1926638927,1674540430,1619053713,1118185465,
	 104723257,  23434677, 394667076, 791104414,1555878958, 769519558,1107883096,1134905313
} };

static const uint32_t vrfy_igms[2][1024] = { {
	     10239, 935697967,1766507046,1303280560,1732718024, 638612301,1636750779, 504566473,
	 443427010,1286088639, 785175701,1066795411, 881646601,1434224914,1060326416,  38227633,
	 785118320, 365846978, 641891035,1393855854, 926381980,1465918355,1787130800, 629043767,
	 927328435,1622117975,1206556750,1721816263,1157428053,1138674867, 107127195, 621647095,
	1130108648, 856581489,1255155123, 808713796,1224137866,1714653576,2127059188,2043343272,
	1115848958,1065940235,  65418321, 858615620, 296033995,1026844461,1345844434,1714688226,
	  44912198, 767158501,1968000027,  41252064, 240908691,1763147179,1698723818,1530206003,
	1908358469,2020025708,  16013836,  37119790,1973607700,1899607806, 643802935, 395692351,
	 287687445,1227333569,1966820999, 370630187,2034200855,1746831059, 835724170, 771697982,
	1446946248,1373988011,1231034004, 787624042,1008645557, 562476830, 720207148,2088889909,
	 899217604,2068338522,1844019235, 514843446, 630790871, 756499761, 128588522, 711398316,
	1784197313,1123572734, 105547851, 545430522,1649686981,1840382441, 378997299,  39577532,
	1536436095,1979427187,1157684245,1954559565,1489121754,1141231051, 407255209,1705032945,
	 225145850, 320100547,1966264149, 764741947,1762902775,1642758760,1309730992,1678761352,
	 776032893, 899231166, 476017679,1204553348, 947165317, 997550449, 292915575,1460323807,
	 122026395,1696819166, 262852661,1610109474, 324163065,1767114891,1438963875,2111470711,
	 610747260,1291711500, 238141642,   7523241,1437515810, 967272142,1588802556,1532523074,
	 886111211, 494748413,1893951232,1316359579,1964741544,1739786831, 345137518, 514787992,
	1140938291,1251585465,1819180713,2074289046,  37086730,2007733658,1084118044, 464745133,
	 914064647,  93786107,1880912667,1085290211,1120911728,1054227797,2040448684, 362694210,
	1621579128, 119744923, 373139849,1230568241, 307075856,1626908401, 800598847,1940403915,
	1836452617,1682897561,2025378919, 879481873,1804099961,1019899674,  38809309,  91556976,
	1338921543,1043365867,1206928721, 715373332, 464121908,1188599559,1208201251, 423480793,
	1467670385,1197225240, 960244440,1796780138,1927662110, 647967889, 807324919,1249278689,
	 814057852, 426959731,2130650614,1046173078,1879123051, 344256772,1279562111,1628463626,
	 261132399,  74381349,    725805,1963125637,1852621742,1700005470,2061608204, 984864062,
	 360248943, 928197082,1299967868, 651214863, 238255702,2133660030, 695333601, 201533321,
	1061958230, 605065903,1526868075,2086082317,1026068242,  41963704, 781139475,1004714703,
	 538217525, 957194835,2117717629,1386915863,1130117204, 362451553,1779312998, 837563331,
	1150852307,  62387834, 861619503,1528794766,1252954495,1323925677, 461043023, 942162252,
	 986977877, 760227573, 163706782, 145366425, 196986985, 404026754,1006876827, 868115139,
	 448326800, 513729258, 671877754, 613667366,1383954164,1969871846, 637915734,1564007062,
	 293815000, 866946295, 493995653, 318838387,  55521150, 683428341, 271726296, 579005089,
	1722791248, 461432047, 810655101, 426746285,1627505451,  22178907,1937060027, 757266757,
	 322433314,2137759493,  26718897, 816165054,1300612096,1809847998,1000467198,2011778531,
	1785928547, 565881153, 638566719,1664772590,1824734840,1701050071,1275919736, 923737858,
	1733168465,2011605054,2063729877,2007572851,  31880737,  71601835, 303540469, 163751374,
	 618966638,  78741980, 794738075,1572339592,1234394823, 407456859, 484407013, 799124403,
	 612966604,2104108192,1130697126,1207020452, 934946290,2079089434,  26437422,1051823187,
	2008067713,1321905360,1875196295,2022829605,  13604704, 608656817,1050245073,1895474916,
	1054655202,  77528272, 422561173, 510324510, 170535902, 343959945,1641647326,1582058336,
	 423448121,1547113296,1361426064,1447069806,1034678154,2143773157,1533509695, 433227307,
	1690156294, 402890201, 847661765, 123122091, 721257641, 186224555, 425583266,1360077723,
	1621169994,1053687372, 438418557,1623524244, 661042405,1204789600,1203970878, 671847688,
	 732707791,1718316976,1642457289, 111482676, 608502846, 310790818,  14948412,1898521680,
	1879185157,  52484578,1311916441, 234047326,1221255253, 620408663, 707301028, 896184512,
	 368083870,1189422761, 185907460,1028399541,1205768910,1075422819,1849784206, 534444127,
	 229239763,1538323253,1152095525, 913164179, 942879474, 124379916, 620036508, 788731941,
	1302793299,1558090412,1763887937, 266307388, 809281283, 313589222,1663892018,2110807117,
	 168199620, 380721970,1975840612,  44987734,1372702382,1416607783, 105215898,1190429047,
	1806805646,1377946814,1004576733,1148137880, 360004050, 168564226, 197925480,1491797704,
	1501487358, 217536013, 848846631, 561946671,2049302885, 402748848,1182975088,1504922064,
	 763772861,  10792080,1653851083, 102348446,2139092741,1015327535, 142698848, 640686480,
	 380471664,1202955593, 760564353, 390332038,1762924121,1254306555,1036692945, 615758479,
	 725498305, 263155860,1997368885,1175806907,1656864440, 420538883,  48133485,1241882785,
	 644322690,1939099487, 738381210,1358911605,1972073188,2026250152, 664504102,1995277988,
	1530424118,2092262955, 291384046, 641640335,2125221740, 468535183,1105624791, 958323799,
	1842039799, 211852254,1634852221, 745248327,1179199210, 552923258,2124840596,1984662082,
	  62409175,1534110059,1685898854, 508712179,1362364817,1571197113,2135674028,1636774192,
	1974190361,1028848640,1558811566,1692953585,1858936641, 727319209, 467089515,2085823791,
	 775675036, 345616711, 172027194, 419326584,1586694526,1133467363,1637797720, 981618177,
	 108373433, 547047932,1853811566, 517224772,1144975794,1479863070, 578674819,1803100132,
	1351870045, 885736855,1502052256,1493054471,1349270466,1615279076,1313471229, 302807815,
	 267860297,1818826428, 846909857, 742751223,1257957249,1105793337, 844599573, 461735609,
	1466819737,1566843913,1418256643, 549921673, 211640767,1307084574,1244468228, 132081293,
	 724735209, 886384080,1683785747,1434937948,1976636513,1671543102, 311816799, 929449899,
	 555251227,1092348544,1696137250,1381832002,1572093290, 820050077,1382007122,1431500989,
	 199969152,  39715537,2076568521,1525196654,1988159461,1131786879, 863722720, 319369556,
	1747962228,1373233965, 839485654,1449624021,1713149853,1690380784,1169518833, 554451672,
	 141449560, 753887896, 695137288, 911154183,1354571844, 193179041,1768435198,1813178192,
	 843217048,1747966621,1889547456, 871925827, 100043762, 388161819,2092993282, 955638798,
	1180306354,1395264631,1008694076,1302361634, 351515302,1875877673,1880626927, 878545018,
	 308743612,1607886923,1221227734,   1987158, 112551031, 456161588,  81596415, 778401654,
	 594817754, 757583666,1900989444,1659596479, 109097638, 312541558,2135377939,1537775915,
	1419710701,1675301240,1570411397, 645532741, 536278863,1164711173, 785225727, 181578431,
	1369645934,1892341214, 579718416,  70796417, 454112355,1243044556, 535383108, 718873021,
	 493719042, 449281861,1123322063, 608987047, 534034298,1089048630, 667484520, 397711116,
	 467992584,1832167203, 267294139,1953352622, 119955347,1388748821,1985683063,1940708279,
	 511783919,1034312416, 317582340, 617955153, 400398562, 651545052,1848624609, 777722606,
	1243023103,2140198763,1607059121,1061617426, 842904490,1242737596, 100606224, 524314468,
	1769157255, 362435621, 581093436,1354427353, 412120247, 186824474,1404842880,1500618807,
	1370915278,1913958990,2082397587, 990573200,1066413751, 510765075, 445071609, 737072393,
	1775702052, 363809217,1600834600,2070490904,  67769199, 624446052,1332770722, 873025660,
	1923059080, 952489965, 288512538, 311600442,1344449279,1182278640,1728086636, 220565044,
	1703868257, 747477231, 120620309,1248542621, 658374976,2088984102,1211436139, 280375598,
	1021277561,1547768798,1025066618, 145361383, 461858167,1220452396,1511998084,  44863300,
	 731906845, 215461151,1935148057,1833766074, 241648565,1909792252, 466694971, 497530637,
	 313398537, 903549724,1892038261,1795082309,1715411174, 992107874, 749594667,1851565653,
	1977243197,1159285757, 435343067,1872746776,1066789848,1206692911,1393615593, 225441914,
	1029163235,1834897340,  39861738,1728490453, 450309893, 466973080,  30524230,1631237378,
	1244911593, 649742973, 588764968, 399079811,  38939133,  38276997,1474593035, 113485973,
	 413633165,1707869061,1517495566,1398919067,1785472268, 572159106,2084240150, 215872523,
	 771650275, 951653038, 449754844,1483940728, 165540917,1500888163, 767471612, 700453260,
	1181596054,1829540513,1507541570,1925333818,1285657604, 579712994,1906474153, 189269246,
	1125682083,  22537852, 219500408,1951158662,1601668280, 503223500,1501701639, 200044656,
	2020106241, 248525894,1806499042, 774830260,1984789971,1827996634, 385047903, 324308910,
	1946619104,1516470323,1131539488, 722597374, 794874168,1068660921, 237052137,1943468426,
	 705987125,1225187506,1365846529, 210844540,1270321087,1667547913, 741781038,1930523970,
	2082483674,1963293679, 473078073, 140927055,1943093743,  61604675,1165843792, 634921693,
	1158176698,1777714809, 230405099, 210632440, 108672111, 939272096,1574630745,1997689506,
	 643319467, 948160968,1626167130, 127935972,2120759583,1976145633,1844136035,2028947983,
	1847662823,1641456576,1585260313,1422092026,1814301259, 520650954,2081620275, 158829739,
	1482773651,2028626591, 202556627, 154783335,2065218977,1713575928, 312226431,1831103029,
	1714731861,1055546268,1784546201,1774509064,1056685883,  94544497,1092214536, 376176510,
	 747205414, 547169781,1399533879,2004605987,1748116944, 521903481, 905562904,1004488103,
	1036459127,1881030797, 865628738,1547349394,1409917131, 482495731, 159779181,1542436779,
	1332391953, 651676045,1911677658,1596435027,2020943709,1130017629,1337194747,1788503022,
	1022923245,1932020844,1898642693, 404485809,2097670978, 108847531, 601410137, 763611448,
	 982569887, 307168324,1017710247, 165517947,2108619736, 654406429,1632461370,1597285479,
	1626394903,1639355832,1690115022, 204260501, 422288412, 627245032,1982838485, 924825552,
	2047188116,1593624697,1781249789,  85526919,1120866564,1775111901, 501455422, 796721499,
	2140929875,1898469191,1994972803, 948496239, 464962892, 773719739,1056698293,1852601452,
	1688380629, 799821622, 141014914,1339020852,1450008015, 283857130, 583164390,1031414908,
	1409732639,1645909209,1887840755,1830950701,1921670011,2076521763,1404259787, 339210146,
	 477179592, 701021067,1796299038, 869044017,1403723104, 927992028,1392515904,1777703395,
	1590438010, 173372425,1447558737,1728219493,1532324293,1330507843,1195949219,1933308126,
	1182831789,1605532375,1692941861,1928366047,2060109677, 722951621, 496943411,1831295364,
	1863379428,  35177317,1807317286, 345000167,1087936750, 364931467, 924540198, 630338567,
	1731068957, 113409718,1888433030,1674970666,1394006050, 190432828,1584235350,2058157417,
	 551906211,1519640895, 281680855, 588317856,   7369075,1838384654,1399429047,2068272902,
	 769233842,1533216511, 511284308,  79452611,1755599292,1624403920, 693837013, 346686923,
	1786915934,1607980628, 598809465, 323412509,1928675711,1314636934, 465461737, 561036523,
	1673256934, 619157358,1740189348, 149985395,1116262072,1813685530,1202745593, 552368755,
	1224503814,1987729801,   8957923,1525351832,1250562639,1459949808,1463229973, 151890618,
	1551181116,1525647030,1262934488,1523910883,1316096495,1873708961,1741793615,1418220531,
	2131551353, 638942773, 698142534, 918700680, 321592564, 879577066,1522304027,1470551307,
	1835129309,2106291578, 123224118,1000571633, 353785867,1692880794, 779084903, 236052161,
	1840461434,  83111881,1149383006, 410669996,1575138173,1015235579,1546074492, 178680936
}, {
	     94207,1746967242, 415203103,1229240283, 832390417, 135245538, 239357287,1257292250,
	 304937236,1835403724,1875383081,1952945966,1393492850,  37227245,2026950028,1379119891,
	1931892797,1218807514,1910910022, 293704725,1797355573, 500204701, 636596715,2142311183,
	1510018083,   6608569, 815528515, 195855968,1089280206, 489075568,1134224819, 791616596,
	1131739521, 759790418,1053132218,1189681182,1435711478,1897957516,1145559968, 790516470,
	 577316887, 357576584,1701637719,1186951860,2070831063,1068233397,1606244498,1838639286,
	1443203279, 453298878, 481158819, 532371143,1964207639, 165231935, 280047414,1501388795,
	 701719610,1688465298, 478507518,  31059823,1231880672, 673399591, 509788483,1370057184,
	1855880672, 574718247, 777097256, 960170434,1241153787, 196741156, 399849129,1188204366,
	1534826516,1807339918,2115910560, 558115737,1070999619, 658191640,2056756843,1202535703,
	1871734625, 846849608,1544158543,1302364508,1791635904, 591351562, 876547071,2007707038,
	1832929314,1479668204, 161801941,1602440785,  95055005,1924507462,1124816557,1937261734,
	 445520520, 293635500, 813610050, 900494287,1785726804, 266411439,2078557707,1397569379,
	2000005563,1888173867,1912987670, 962456017, 928803938,1178579020,1353744418,1136238845,
	 272835546, 390686374, 307339784,1496350289,1702631864,1192547444,2129985257,2039776108,
	  77449754,  57574823, 576265880, 495882264, 405341530, 823855649,1825226484,1805862361,
	2081396521,1863243584,1382099447,  17848506, 142659844,  10490175,2010841216, 523620785,
	 134771553,1003391967,2026347440, 559346743, 104125321,2081846844,1410047456, 860337971,
	 444453863,1696943244, 177469476,1757209242, 544477856,1532946010,  94417257, 840234354,
	  22907506, 401966561,1335508732, 873591713,1953719197,1393401933,  61394358,2042016455,
	1857554961, 876846428, 910921946,2132876213,2069751270,1043734949,2006566810, 630468973,
	1615318576,1005551847, 899044625, 254043107, 450184683,1418510545,1852749557,1623483041,
	1183967598, 884275251, 537134193,1795598166, 205092250,2085442661, 116113198,1003285657,
	1936680611,2057268648,1406921330, 429536115, 536383262,1931534127,1613321766,1802414762,
	 515151423, 535061700,1623123052,1084895603, 307446767,2073958665,1354100321,1575828724,
	 900029781,1513675021, 531938791, 395019779, 332000960, 706407968, 610398435,1131194964,
	 828599853,1839576284, 121738296,1979202357, 795036567, 617851226,2073049652,1995947698,
	 748341551, 703621826,1800570760,1271186533, 683226225,1111801782,1252191745,1863847101,
	 623693069,1449836286,2121405892, 831450039,1540564497,1546132775,1438095602, 777798160,
	2041750488, 962225217, 917223285,1338509381,  71289744, 187929751,1181381390,1175573360,
	1718966433, 475194986, 795594648, 345481917, 356338834, 498996271, 125462412,1338514283,
	2021329417, 527348461, 275949242, 979608537, 694298996, 575818969,1484691680, 353278096,
	2082527953, 891033298,1475766047, 751780915,  88360282,1840972698, 437762590,1807928381,
	 476379986, 672707637, 852536003, 713510162, 406960857,1377011996,2074800091, 149441023,
	1000512950,1728218782, 863010731,1546663524,1174460446,1178503823,1950076519,1386144321,
	 910456378,1308042189,1160619640, 901788390,1862468600,1293782647,2059173707,1498864128,
	 731833502,1088237846,1346588067,  20539534,2086687353,1343287481,1928333759,1203132123,
	2070040672, 697224304, 901600452,2072139040, 899151097,1189370084,2130582382, 275298414,
	1920438454, 340341679,1812169797, 172195237,1213124455, 652898206,1986240932, 537927863,
	1993280799,1356335893,1696352512, 950365255,1850391126,1314778174, 598949948,2129025915,
	 455037244,1913430226,1168138119,1734364420,1112727219,1976498953,1627937919,1000650711,
	1565931776,1614454880, 457428106, 228325340,2116412485,2015574191,1644188065,1407158770,
	  98450678, 674583603, 176065582,1454183749,1734028323,1055105779,1298575014,1079457340,
	1453576311, 878095198,1577992168, 973914432, 551366821,1917294251, 533449648, 415570220,
	 841562986,1462459469, 954259200, 753240481, 534799001,1036308734,  68870492, 701811079,
	 492629482,1042567019,1008941190,1931590492,1068290564, 164592745,1143168897,1218351521,
	 273018085, 332289039,1289717304,1571176513,1062370075, 958370760,1358295093,1101997887,
	 967438075,1889162613,2130456375,1030144010,1318186939,2018520212,  98895572, 591450901,
	1479412817,1075651622,1803767218,1029126813,1056214954,1750910221,1976205092,2031666508,
	1476140252, 591268798, 557471162,1267992595,1831358300,1631977370, 134415089, 918701560,
	 630901294, 937859937, 895849995,1372230382, 489904242, 280632899, 654740589, 578288408,
	 216390526,1594415849,  96757065,1687994620, 399898469,1393253534,1564928045, 381211263,
	2142787750,1624397294, 264587289, 586072498, 353931167,1021852956, 581705041,1853981758,
	1521817792, 859404404,2082944813,1202869634, 786579478, 119279919, 457264953,2066919992,
	1484775107, 204007461, 723431187,1272889802, 635501476, 130284895,1726264035, 149424353,
	2100067713, 310900266, 469356483,  89779525,1114576405,1703458545,1189914970, 446639836,
	 660002883,1541527032, 586594160,  29461339, 681873427, 511564224,  71902184,2078557543,
	1704502411,1737365228,1731173247, 875076145,1955606757, 878910476,1900613747, 631999626,
	 544618407,  52008260,1942878707, 466686401, 603921258,1545770812,1696405765,1504882825,
	1425545355,1500373671, 530471344,1104125583,1204029357,1589257478,1390626780, 783447924,
	 443212666, 130881686,1941741707, 781376171, 405592902,1339460704, 746355230, 331022281,
	1457025460, 753583479,1924798508, 252396355, 451007081,  29490404,2141752657,1972810731,
	1981996780,1233932117,1530769388,2053605876, 683730090, 101775112,2093362307, 784620698,
	1885822935,1077499966, 477447292, 122000175, 262053431,1681609229, 249993228, 571946643,
	1012484128,1039506345,1377869883, 591510483,1356285027,1752722365,2123954764,2042666184,
	1029203976, 528335728, 472849011, 220750514,1278349344, 108837906,1446559740, 342428820,
	 990055861, 128738407,1318049471, 366305717,1460736577, 711359701,1077274696,1733033020,
	 770629299, 606160005, 825465142,1568946811,1281155015,1583326113,2013444017, 437766416,
	1148911802, 977085469,1194647682,1957713463, 242929263,1057594107,1611670465,1851557976,
	1798032113,1710176989, 785026738,1044237619,1989129417,1699739547,1620103939, 374437824,
	 263884277, 803990192, 611686109, 464649556,1865214277, 931774747,1509339125, 464110333,
	1602523739,1251326650,1052914884,1648375031,1062650233,1636779943, 382428072,1718315947,
	1540375939,1737589038,1241558888, 747478299,1819048832, 855620235,1184270729,1268893258,
	1079828283,1706920421,1435067665,1974896669, 841732009, 813786338, 828229537, 458500913,
	 500338455, 332618641,1639801708, 312707614, 517293105, 691227393, 895972430,1189046409,
	 373429739, 165194641,1529825940, 912293590,  42408804,2104083333, 185979309,1536113510,
	1771210156, 451094734, 243677094, 746872148, 517107320,1597353805,1675631303,1716900585,
	 430298758,  62346840, 895883177, 752145400,1365390610, 763317612,  50582710, 679993432,
	1513756681,1986260149, 983824965,2017361471,  85096835,  66879108, 690697723, 970431585,
	1055255864,1789155482,2118773793,1928170486, 256642602,1577358681,1267869563,1438807330,
	1609039592,1127700758, 891494827, 275436172, 839027604, 582366440, 561935415,1428895389,
	1184898098,1810919357,2053381545, 380170468,1142186736,2060235931, 279287681, 625671821,
	 567853944,  95129629,2075542353,2144539594,1496114004,2046245220,1858819078, 299373614,
	 350565435, 567052326,1738823181, 744605409, 388763686,1782767324,2060020492,1356002599,
	1608906576, 241874975,1366507317,  34568556,1685727786, 764868888,1204884038, 860845869,
	 253616609,1337944528,1460976831, 256520921, 283561623,1179826737,2115064213,1928210923,
	 190824409,1996892861,1514145974,1731597045,1447725873, 510742455,1170456700,1943612915,
	 153981524,1869788197,1090383008, 908977234, 636369526,1830615762,1961242832,1915417502,
	  99396098,1154022138, 915271452,1965580901,1804991926,1278965910, 731738010,2060425262,
	 286028809,1392989713, 631300217, 367205302,1034946288, 983747216,1190378103,1778399110,
	1285752728,1108968158,1006691196,1165831763,2139717595,  97553730, 275799276,1285487464,
	1825525968,1684218577,1030896436,1897939559,  37098246,1254149930,1171981085,1352577656,
	 317104292,  79521845,1860124905, 355706659,1337594758, 640387018,2010367764,1229864786,
	1779357856, 298101426, 813926451, 744875466, 936792421,1625877379,1713761188,1397144715,
	1078914749,1565072012,1230395244,2043653988,1691477288,1196193238,1648702966,1760963569,
	1952072143,1982636486,1668352072, 974033943, 426312075,1918355261,1355187525,1631648373,
	 153708327,1197328054,1070726938,1990423194,2029673731,  35847911,1848280403,2002257210,
	 316054041,1806573153,1183026058,1912034791,1455128409,1978433745, 645793936,1080063060,
	 594859711,1410424597,1285224744,1231529058, 592166656,1818946982,1282742449,1068385246,
	 204538076,1160821679, 919525363, 917910680,2131739309, 525823061, 661924725, 468971431,
	 404085339,2105903525,1948392178,   1884980,1108900648, 920549731,1161336101, 110778561,
	1957065070,1630404472,   7916198,1310679278,1653613269,1302642880,1281565663, 600062508,
	1498953474,1947637354, 325478227,1301077486,1444341347, 542408014, 711662023,1927560929,
	2056769989, 912994168, 412805933, 497189991,1441143101,1628507035,1052213616, 418503547,
	1902211180,1496836164,1228431491,1139689378, 325193519, 366127564,1597424577, 552750992,
	 842158967,1179600501,1930642749,2117101169, 212293228, 864227233,1741512700,1596939041,
	 589109416,1664501271,1886451919, 207411323,1341529639,1790443045, 402636300,1619614843,
	1652296667,1712482256, 155152581,2058042923,1705387722,1876996268,1919525184,1673603091,
	 300098586,1738292014,1631413937,1918656857, 823176503, 986411663, 363672162, 297846983,
	 904530490, 981402667,1818414597,  98262497,2134701179, 886274664,1481654806,1175328854,
	1443511013, 796811379, 520482217,1065728172, 657374859,1794311772, 107752928,1196414804,
	 366901398, 529566228,2022685610,1104265934,1027825948,1511910894, 477016963,1670561987,
	1713575739, 861990854, 210710957,1799114727,  17766888, 114653151,1081800333,1231936378,
	1205189027,1264327132,1613534912,2052442022,1553385216, 268680156, 570131205,1410473024,
	1984000721,1311559057,  66732192, 392748961,1666865996, 675736453,1595553847,1157205494,
	 724267928,2109842037,1957600385, 246220502, 455502284,1935434049, 345367123, 720312184,
	1202952686, 967725246,  97547108, 407366600,1159849023,1388001701, 291465185,1090891113,
	 938142418, 736805877, 132316949,1156052302,1597095138, 918105089, 131645226,1377265200,
	1874932091, 575727951,1773880777, 753283835,1568240597, 843931506,  23612391, 847974694,
	1872796393, 928746772,  20115187, 195672028, 883327252, 381520423,1254323671,2071213387,
	 889774693,1897966437, 167620071, 234080711,1770793502,1696993607,1265546761, 948620176,
	1388141816, 942244683,1518184950,2093890470,1022054167,2014776274, 813820946,1023660742,
	1330538929, 124538333, 485033758, 364236423, 158959825, 435217835, 702329604, 177149349,
	1515705842,1981594574,1578282586, 512897333, 762393432,1070648407, 930172896, 972047518,
	 784819687, 923123240, 302605639,1064070723, 825515558,2092350368, 339717938, 662541087,
	1107094075,1577674946,1859336385, 133137162, 409314295,2134311051, 237576084,2056409855,
	 472961253, 192971313, 710947613,2018203442,1914921499, 436915036, 301267481, 859796248,
	1245522992,1956134275,1947876082,1997260078,2005384676, 375985663, 924553283,1808561878
} };

/*
 * Reduce a small signed integer modulo a small prime. The source
 * value x MUST be such that -p < x < p.
 */
static inline uint32_t
modp_set(int32_t x, uint32_t p)
{
	uint32_t w;

	w = (uint32_t)x;
	w += p & -(w >> 31);
	return w;
}

/*
 * Normalize a modular integer around 0.
 */
static inline int32_t
modp_norm(uint32_t x, uint32_t p)
{
	return (int32_t)(x - (p & (((x - ((p + 1) >> 1)) >> 31) - 1)));
}

/*
 * Compute -1/p mod 2^31. This works for all odd integers p that fit
 * on 31 bits.
 */
static uint32_t
modp_ninv31(uint32_t p)
{
	uint32_t y;

	y = 2 - p;
	y *= 2 - p * y;
	y *= 2 - p * y;
	y *= 2 - p * y;
	y *= 2 - p * y;
	return (uint32_t)0x7FFFFFFF & -y;
}

/*
 * Compute R = 2^31 mod p.
 */
static inline uint32_t
modp_R(uint32_t p)
{
	/*
	 * Since 2^30 < p < 2^31, we know that 2^31 mod p is simply
	 * 2^31 - p.
	 */
	return ((uint32_t)1 << 31) - p;
}

/*
 * Addition modulo p.
 */
static inline uint32_t
modp_add(uint32_t a, uint32_t b, uint32_t p)
{
	uint32_t d;

	d = a + b - p;
	d += p & -(d >> 31);
	return d;
}

/*
 * Subtraction modulo p.
 */
static inline uint32_t
modp_sub(uint32_t a, uint32_t b, uint32_t p)
{
	uint32_t d;

	d = a - b;
	d += p & -(d >> 31);
	return d;
}

/*
 * Montgomery multiplication modulo p. The 'p0i' value is -1/p mod 2^31.
 * It is required that p is an odd integer.
 */
static inline uint32_t
modp_montymul(uint32_t a, uint32_t b, uint32_t p, uint32_t p0i)
{
	uint64_t z, w;
	uint32_t d;

	z = (uint64_t)a * (uint64_t)b;
	w = ((z * p0i) & (uint64_t)0x7FFFFFFF) * p;
	d = (uint32_t)((z + w) >> 31) - p;
	d += p & -(d >> 31);
	return d;
}

/*
 * Compute R2 = 2^62 mod p.
 */
static uint32_t
modp_R2(uint32_t p, uint32_t p0i)
{
	uint32_t z;

	/*
	 * Compute z = 2^31 mod p (this is the value 1 in Montgomery
	 * representation), then double it with an addition.
	 */
	z = modp_R(p);
	z = modp_add(z, z, p);

	/*
	 * Square it five times to obtain 2^32 in Montgomery representation
	 * (i.e. 2^63 mod p).
	 */
	z = modp_montymul(z, z, p, p0i);
	z = modp_montymul(z, z, p, p0i);
	z = modp_montymul(z, z, p, p0i);
	z = modp_montymul(z, z, p, p0i);
	z = modp_montymul(z, z, p, p0i);

	/*
	 * Halve the value mod p to get 2^62.
	 */
	z = (z + (p & -(z & 1))) >> 1;
	return z;
}


static inline uint32_t
modp_inv(uint32_t a, uint32_t p)
{
	uint32_t b;
	int64_t x, xx, q, t;

	b = p;
	x = 1;
	xx = 0;

	while (b) {
		q = a / b;

		// x -= a / b * xx; swap(x, xx);
		t = x - q * xx;
		x = xx;
		xx = t;

		// a %= b; swap(a, b);
		t = a - q * b;
		a = b;
		b = t;
	}

	return modp_set(x, p);
}

/*
 * Division modulo p. If the divisor (b) is 0, then 0 is returned.
 * This function computes proper results only when p is prime.
 *
 * Note: p should be public variable, i.e. the runtime depends on p.
 *
 * Parameters:
 *   a     dividend
 *   b     divisor
 *   p     odd prime modulus
 *   p0i   -1/p mod 2^31
 *   R     2^31 mod p
 */
static inline uint32_t
modp_div(uint32_t a, uint32_t b, uint32_t p, uint32_t p0i)
{
	return modp_montymul(a, modp_inv(modp_montymul(b, 1, p, p0i), p), p, p0i);
}

/*
 * Compute the NTT over a polynomial a (binary case).
 */
static void
modp_NTT2(uint32_t *a, const uint32_t *gm, unsigned logn,
	uint32_t p, uint32_t p0i)
{
	size_t t, m, n;

	if (logn == 0) {
		return;
	}
	n = MKN(logn);
	t = n;
	for (m = 1; m < n; m <<= 1) {
		size_t ht, u, v1;

		ht = t >> 1;
		for (u = 0, v1 = 0; u < m; u ++, v1 += t) {
			uint32_t s;
			size_t v;
			uint32_t *r1, *r2;

			s = gm[m + u];
			r1 = a + v1;
			r2 = r1 + ht;
			for (v = 0; v < ht; v ++, r1 ++, r2 ++) {
				uint32_t x, y;

				x = *r1;
				y = modp_montymul(*r2, s, p, p0i);
				*r1 = modp_add(x, y, p);
				*r2 = modp_sub(x, y, p);
			}
		}
		t = ht;
	}
}

/*
 * Compute the inverse NTT over a polynomial (binary case).
 */
static void
modp_iNTT2(uint32_t *a, const uint32_t *igm, unsigned logn,
	uint32_t p, uint32_t p0i)
{
	size_t t, m, n, k;
	uint32_t ni;
	uint32_t *r;

	if (logn == 0) {
		return;
	}
	n = MKN(logn);
	t = 1;
	for (m = n; m > 1; m >>= 1) {
		size_t hm, dt, u, v1;

		hm = m >> 1;
		dt = t << 1;
		for (u = 0, v1 = 0; u < hm; u ++, v1 += dt) {
			uint32_t s;
			size_t v;
			uint32_t *r1, *r2;

			s = igm[hm + u];
			r1 = a + v1;
			r2 = r1 + t;
			for (v = 0; v < t; v ++, r1 ++, r2 ++) {
				uint32_t x, y;

				x = *r1;
				y = *r2;
				*r1 = modp_add(x, y, p);
				*r2 = modp_montymul(
					modp_sub(x, y, p), s, p, p0i);
			}
		}
		t = dt;
	}

	/*
	 * We need 1/n in Montgomery representation, i.e. R/n. Since
	 * 1 <= logn <= 10, R/n is an integer; morever, R/n <= 2^30 < p,
	 * thus a simple shift will do.
	 */
	ni = (uint32_t)1 << (31 - logn);
	for (k = 0, r = a; k < n; k ++, r ++) {
		*r = modp_montymul(*r, ni, p, p0i);
	}
}

static void
int16_to_ntt(uint32_t *a, const int16_t *x, const uint32_t *gm,
	uint32_t p, uint32_t p0i, unsigned logn)
{
	size_t n, u;

	n = MKN(logn);
	for (u = 0; u < n; u++) {
		a[u] = modp_set(x[u], p);
	}

	modp_NTT2(a, gm, logn, p, p0i);
}

/*
 * Set the polynomial a equal to h - 2 * s and converts it to Montgomery NTT
 * representation.
 */
static void
hash_to_ntt(uint32_t *a, const uint8_t *h, const int16_t *s,
	const uint32_t *gm, uint32_t R2, uint32_t p, uint32_t p0i, unsigned logn)
{
	size_t n, u, v;
	int32_t hash;

	n = MKN(logn);
	if (logn <= 3) {
		hash = h[0];
		for (u = 0; u < n; u ++) {
			a[u] = modp_set(((hash >> u) & 1) - 2 * s[u], p);
		}
	} else {
		for (u = 0; u < n; ) {
			hash = *h++;
			for (v = 0; v < 8; v ++, u ++) {
				a[u] = modp_set((hash & 1) - 2 * s[u], p);
				hash >>= 1;
			}
		}
	}

	modp_NTT2(a, gm, logn, p, p0i);
	for (u = 0; u < n; u++) {
		a[u] = modp_montymul(a[u], R2, p, p0i);
	}
}

/*
 * This a helper function for Zf(uncompressed_verify_NTT) and Zf(verify_NTT),
 * since these both calculate the norm of (s0, s1) modulo various primes with
 * respect to a quadratic form Q.
 * However, in Zf(verify_NTT), some of the computations are already done.
 */
static int
verify_norm_NTT(const uint8_t *restrict h,
	const int16_t *restrict s0, const int16_t *restrict s1,
	const int16_t *restrict q00, const int16_t *restrict q10,
	unsigned logn, uint8_t *restrict tmp)
{
	/*
	 * TODO: since q00, q11 are selfadjoint, write a NTT, iNTT version for
	 * selfadjoints that only uses first half of coefficients, saving 4n bytes.
	 */

	uint32_t norm, normp, term;
	uint32_t *s0_i32, *s1_i32, *r0_i32, *r1_i32;
	uint32_t p, p0i, R2;
	const uint32_t *gm, *igm;
	int32_t *q11;
	size_t n, hn, u;

	n = MKN(logn);
	hn = n >> 1;

	norm = 0;
	normp = 0;

	s0_i32 = (uint32_t *)tmp;
	s1_i32 = s0_i32 + n;
	r0_i32 = s1_i32 + n;
	r1_i32 = r0_i32 + n;
	q11 = (int32_t *)r1_i32;

	p = PRIMES[0];
	gm = vrfy_gms[0];
	igm = vrfy_igms[0];
	p0i = modp_ninv31(p);
	R2 = modp_R2(p, p0i);

	hash_to_ntt(s0_i32, h, s0, gm, R2, p, p0i, logn);
	hash_to_ntt(s1_i32, SECOND_HASH(h, logn), s1, gm, R2, p, p0i, logn);

	/*
	 * Store q00 in r0_i32 and assume q10 is in r1_i32 (NTT representation).
	 */
	int16_to_ntt(r0_i32, q00, gm, p, p0i, logn);

	// s0* q00 s0
	for (u = 0; u < hn; u++) {
		term = modp_montymul(s0_i32[u], s0_i32[n - 1 - u], p, p0i);
		norm = modp_add(norm, modp_montymul(term, r0_i32[u], p, p0i), p);
	}

	// s0* q01 s1 + s1* q10 s0
	for (u = 0; u < n; u++) {
		term = modp_montymul(s1_i32[u], s0_i32[n - 1 - u], p, p0i);
		norm = modp_add(norm, modp_montymul(term, r1_i32[u], p, p0i), p);
	}

	/*
	 * Now determine q11 = (1 + q10*q01) / q00.
	 */
	for (u = 0; u < hn; u++) {
		r1_i32[u] = modp_montymul(r1_i32[u], R2, p, p0i);
		r1_i32[u] = modp_montymul(r1_i32[u], r1_i32[n - 1 - u], p, p0i);
		r1_i32[u] = modp_add(r1_i32[u], 1u, p);
		r1_i32[u] = modp_div(r1_i32[u], r0_i32[u], p, p0i);

		// Needed for the iNTT:
		r1_i32[n - 1 - u] = r1_i32[u];
	}

	// s1* q11 s1
	for (u = 0; u < hn; u++) {
		term = modp_montymul(s1_i32[u], s1_i32[n - 1 - u], p, p0i);
		norm = modp_add(norm, modp_montymul(term, r1_i32[u], p, p0i), p);
	}

	/*
	 * Store q11 for later checks, since taking the inverse (modp_div) is
	 * expensive modulo a prime p.
	 */
	modp_iNTT2(r1_i32, igm, logn, p, p0i);
	for (u = 0; u < n; u++) {
		q11[u] = modp_norm(r1_i32[u], p);
	}

	p = PRIMES[1];
	gm = vrfy_gms[1];
	igm = vrfy_igms[1];
	p0i = modp_ninv31(p);
	R2 = modp_R2(p, p0i);

	hash_to_ntt(s0_i32, h, s0, gm, R2, p, p0i, logn);
	hash_to_ntt(s1_i32, SECOND_HASH(h, logn), s1, gm, R2, p, p0i, logn);

	// s0* q00 s0
	int16_to_ntt(r0_i32, q00, gm, p, p0i, logn);
	for (u = 0; u < hn; u++) {
		term = modp_montymul(s0_i32[u], s0_i32[n - 1 - u], p, p0i);
		normp = modp_add(normp, modp_montymul(term, r0_i32[u], p, p0i), p);
	}

	// s0* q01 s1 + s1* q10 s0
	int16_to_ntt(r0_i32, q10, gm, p, p0i, logn);
	for (u = 0; u < n; u++) {
		term = modp_montymul(s1_i32[u], s0_i32[n - 1 - u], p, p0i);
		normp = modp_add(normp, modp_montymul(term, r0_i32[u], p, p0i), p);
	}

	// s1* q11 s1
	// int32_to_ntt(r0_i32, q11, gm, p, p0i, logn);
	for (u = 0; u < n; u++)
		r0_i32[u] = modp_set(q11[u], p);
	modp_NTT2(r0_i32, gm, logn, p, p0i);

	for (u = 0; u < hn; u++) {
		term = modp_montymul(s1_i32[u], s1_i32[n - 1 - u], p, p0i);
		normp = modp_add(normp, modp_montymul(term, r0_i32[u], p, p0i), p);
	}

	return Zf(in_positive_half)(s1, SECOND_HASH(h, logn), logn)
		&& norm == normp
		&& (norm & (hn - 1)) == 0
		&& (norm >> (logn - 1)) <= L2BOUND(logn);
}


/******************************************************************************
 *
 * Fixed point precision
 *
 *****************************************************************************/
#define ACCURACY (8)

/*
 * This datastructure resembles a fixed-point precision number,
 * having a value of `m * 2^-ACCURACY`.
 */
typedef int64_t fpp;

static inline fpp fpp_of(int m) { return (int64_t)m * (int64_t)(1 << ACCURACY); }
static inline int32_t fpp_rint(fpp x) { return (x + (1 << (ACCURACY-1))) >> ACCURACY; }
static inline fpp fpp_neg(fpp x) { return -x; }
static inline fpp fpp_half(fpp x) { return x>>1; }
static inline fpp fpp_add(fpp a, fpp b) { return a + b; }
static inline fpp fpp_sub(fpp a, fpp b) { return a - b; }
static inline fpp fpp_div(fpp a, fpp b) { return a * (int64_t)(1 << ACCURACY) / b; }

const int64_t fpp_gm_tab[] = {
	      0,       0,       0, 1048576,  741455,  741455, -741455,  741455,
	 968758,  401273, -401273,  968758,  401273,  968758, -968758,  401273,
	1028428,  204567, -204567, 1028428,  582558,  871859, -871859,  582558,
	 871859,  582558, -582558,  871859,  204567, 1028428,-1028428,  204567,
	1043527,  102778, -102778, 1043527,  665210,  810560, -810560,  665210,
	 924761,  494295, -494295,  924761,  304386, 1003425,-1003425,  304386,
	1003425,  304386, -304386, 1003425,  494295,  924761, -924761,  494295,
	 810560,  665210, -665210,  810560,  102778, 1043527,-1043527,  102778,
	1047313,   51451,  -51451, 1047313,  704181,  776944, -776944,  704181,
	 947901,  448324, -448324,  947901,  353255,  987281, -987281,  353255,
	1017151,  254783, -254783, 1017151,  539076,  899394, -899394,  539076,
	 842224,  624636, -624636,  842224,  153858, 1037227,-1037227,  153858,
	1037227,  153858, -153858, 1037227,  624636,  842224, -842224,  624636,
	 899394,  539076, -539076,  899394,  254783, 1017151,-1017151,  254783,
	 987281,  353255, -353255,  987281,  448324,  947901, -947901,  448324,
	 776944,  704181, -704181,  776944,   51451, 1047313,-1047313,   51451,
	1048260,   25733,  -25733, 1048260,  723036,  759428, -759428,  723036,
	 958618,  424926, -424926,  958618,  377377,  978314, -978314,  377377,
	1023098,  229744, -229744, 1023098,  560986,  885893, -885893,  560986,
	 857300,  603779, -603779,  857300,  179267, 1033138,-1033138,  179267,
	1040690,  128357, -128357, 1040690,  645117,  826641, -826641,  645117,
	 912352,  516841, -516841,  912352,  279669, 1010592,-1010592,  279669,
	 995652,  328919, -328919,  995652,  471452,  936614, -936614,  471452,
	 793991,  684901, -684901,  793991,   77138, 1045735,-1045735,   77138,
	1045735,   77138,  -77138, 1045735,  684901,  793991, -793991,  684901,
	 936614,  471452, -471452,  936614,  328919,  995652, -995652,  328919,
	1010592,  279669, -279669, 1010592,  516841,  912352, -912352,  516841,
	 826641,  645117, -645117,  826641,  128357, 1040690,-1040690,  128357,
	1033138,  179267, -179267, 1033138,  603779,  857300, -857300,  603779,
	 885893,  560986, -560986,  885893,  229744, 1023098,-1023098,  229744,
	 978314,  377377, -377377,  978314,  424926,  958618, -958618,  424926,
	 759428,  723036, -723036,  759428,   25733, 1048260,-1048260,   25733,
	1048497,   12868,  -12868, 1048497,  732301,  750498, -750498,  732301,
	 963761,  413131, -413131,  963761,  389354,  973609, -973609,  389354,
	1025840,  217172, -217172, 1025840,  571815,  878942, -878942,  571815,
	 864645,  593213, -593213,  864645,  191931, 1030861,-1030861,  191931,
	1042187,  115576, -115576, 1042187,  655213,  818662, -818662,  655213,
	 918626,  505606, -505606,  918626,  292049, 1007084,-1007084,  292049,
	 999614,  316676, -316676,  999614,  482910,  930758, -930758,  482910,
	 802336,  675106, -675106,  802336,   89965, 1044709,-1044709,   89965,
	1046603,   64299,  -64299, 1046603,  694593,  785526, -785526,  694593,
	 942328,  459922, -459922,  942328,  341113,  991541, -991541,  341113,
	1013948,  267246, -267246, 1013948,  527998,  905941, -905941,  527998,
	 834495,  634924, -634924,  834495,  141118, 1039037,-1039037,  141118,
	1035261,  166575, -166575, 1035261,  614254,  849826, -849826,  614254,
	 892711,  550072, -550072,  892711,  242282, 1020201,-1020201,  242282,
	 982871,  365343, -365343,  982871,  436658,  953332, -953332,  436658,
	 768244,  713662, -713662,  768244,   38595, 1047865,-1047865,   38595,
	1047865,   38595,  -38595, 1047865,  713662,  768244, -768244,  713662,
	 953332,  436658, -436658,  953332,  365343,  982871, -982871,  365343,
	1020201,  242282, -242282, 1020201,  550072,  892711, -892711,  550072,
	 849826,  614254, -614254,  849826,  166575, 1035261,-1035261,  166575,
	1039037,  141118, -141118, 1039037,  634924,  834495, -834495,  634924,
	 905941,  527998, -527998,  905941,  267246, 1013948,-1013948,  267246,
	 991541,  341113, -341113,  991541,  459922,  942328, -942328,  459922,
	 785526,  694593, -694593,  785526,   64299, 1046603,-1046603,   64299,
	1044709,   89965,  -89965, 1044709,  675106,  802336, -802336,  675106,
	 930758,  482910, -482910,  930758,  316676,  999614, -999614,  316676,
	1007084,  292049, -292049, 1007084,  505606,  918626, -918626,  505606,
	 818662,  655213, -655213,  818662,  115576, 1042187,-1042187,  115576,
	1030861,  191931, -191931, 1030861,  593213,  864645, -864645,  593213,
	 878942,  571815, -571815,  878942,  217172, 1025840,-1025840,  217172,
	 973609,  389354, -389354,  973609,  413131,  963761, -963761,  413131,
	 750498,  732301, -732301,  750498,   12868, 1048497,-1048497,   12868,
	1048556,    6434,   -6434, 1048556,  736892,  745991, -745991,  736892,
	 966278,  407209, -407209,  966278,  395321,  971202, -971202,  395321,
	1027153,  210873, -210873, 1027153,  577197,  875417, -875417,  577197,
	 868268,  587896, -587896,  868268,  198253, 1029664,-1029664,  198253,
	1042877,  109179, -109179, 1042877,  660224,  814627, -814627,  660224,
	 921711,  499960, -499960,  921711,  298223, 1005273,-1005273,  298223,
	1001538,  310537, -310537, 1001538,  488612,  927777, -927777,  488612,
	 806463,  670171, -670171,  806463,   96374, 1044138,-1044138,   96374,
	1046978,   57876,  -57876, 1046978,  699400,  781250, -781250,  699400,
	 945133,  454132, -454132,  945133,  347190,  989429, -989429,  347190,
	1015569,  261020, -261020, 1015569,  533547,  902684, -902684,  533547,
	 838376,  629792, -629792,  838376,  147491, 1038151,-1038151,  147491,
	1036263,  160219, -160219, 1036263,  619456,  846041, -846041,  619456,
	 896069,  544584, -544584,  896069,  248537, 1018696,-1018696,  248537,
	 985094,  359306, -359306,  985094,  442499,  950634, -950634,  442499,
	 772608,  708935, -708935,  772608,   45024, 1047609,-1047609,   45024,
	1048083,   32165,  -32165, 1048083,  718362,  763850, -763850,  718362,
	 955993,  430800, -430800,  955993,  371367,  980611, -980611,  371367,
	1021669,  236018, -236018, 1021669,  555539,  889319, -889319,  555539,
	 853579,  609028, -609028,  853579,  172924, 1034219,-1034219,  172924,
	1039883,  134740, -134740, 1039883,  640033,  830584, -830584,  640033,
	 909164,  522430, -522430,  909164,  273462, 1012289,-1012289,  273462,
	 993616,  335022, -335022,  993616,  465696,  939489, -939489,  465696,
	 789774,  689760, -689760,  789774,   70720, 1046188,-1046188,   70720,
	1045242,   83553,  -83553, 1045242,  680017,  798179, -798179,  680017,
	 933703,  477190, -477190,  933703,  322804,  997652, -997652,  322804,
	1008857,  285864, -285864, 1008857,  511233,  915506, -915506,  511233,
	 822667,  650177, -650177,  822667,  121969, 1041458,-1041458,  121969,
	1032019,  185602, -185602, 1032019,  598507,  860988, -860988,  598507,
	 882434,  566411, -566411,  882434,  223462, 1024488,-1024488,  223462,
	 975980,  383373, -383373,  975980,  419036,  961208, -961208,  419036,
	 754977,  727682, -727682,  754977,   19301, 1048398,-1048398,   19301,
	1048398,   19301,  -19301, 1048398,  727682,  754977, -754977,  727682,
	 961208,  419036, -419036,  961208,  383373,  975980, -975980,  383373,
	1024488,  223462, -223462, 1024488,  566411,  882434, -882434,  566411,
	 860988,  598507, -598507,  860988,  185602, 1032019,-1032019,  185602,
	1041458,  121969, -121969, 1041458,  650177,  822667, -822667,  650177,
	 915506,  511233, -511233,  915506,  285864, 1008857,-1008857,  285864,
	 997652,  322804, -322804,  997652,  477190,  933703, -933703,  477190,
	 798179,  680017, -680017,  798179,   83553, 1045242,-1045242,   83553,
	1046188,   70720,  -70720, 1046188,  689760,  789774, -789774,  689760,
	 939489,  465696, -465696,  939489,  335022,  993616, -993616,  335022,
	1012289,  273462, -273462, 1012289,  522430,  909164, -909164,  522430,
	 830584,  640033, -640033,  830584,  134740, 1039883,-1039883,  134740,
	1034219,  172924, -172924, 1034219,  609028,  853579, -853579,  609028,
	 889319,  555539, -555539,  889319,  236018, 1021669,-1021669,  236018,
	 980611,  371367, -371367,  980611,  430800,  955993, -955993,  430800,
	 763850,  718362, -718362,  763850,   32165, 1048083,-1048083,   32165,
	1047609,   45024,  -45024, 1047609,  708935,  772608, -772608,  708935,
	 950634,  442499, -442499,  950634,  359306,  985094, -985094,  359306,
	1018696,  248537, -248537, 1018696,  544584,  896069, -896069,  544584,
	 846041,  619456, -619456,  846041,  160219, 1036263,-1036263,  160219,
	1038151,  147491, -147491, 1038151,  629792,  838376, -838376,  629792,
	 902684,  533547, -533547,  902684,  261020, 1015569,-1015569,  261020,
	 989429,  347190, -347190,  989429,  454132,  945133, -945133,  454132,
	 781250,  699400, -699400,  781250,   57876, 1046978,-1046978,   57876,
	1044138,   96374,  -96374, 1044138,  670171,  806463, -806463,  670171,
	 927777,  488612, -488612,  927777,  310537, 1001538,-1001538,  310537,
	1005273,  298223, -298223, 1005273,  499960,  921711, -921711,  499960,
	 814627,  660224, -660224,  814627,  109179, 1042877,-1042877,  109179,
	1029664,  198253, -198253, 1029664,  587896,  868268, -868268,  587896,
	 875417,  577197, -577197,  875417,  210873, 1027153,-1027153,  210873,
	 971202,  395321, -395321,  971202,  407209,  966278, -966278,  407209,
	 745991,  736892, -736892,  745991,    6434, 1048556,-1048556,    6434,
	1048571,    3217,   -3217, 1048571,  739177,  743726, -743726,  739177,
	 967522,  404243, -404243,  967522,  398299,  969984, -969984,  398299,
	1027795,  207721, -207721, 1027795,  579880,  873642, -873642,  579880,
	 870068,  585230, -585230,  870068,  201411, 1029051,-1029051,  201411,
	1043207,  105979, -105979, 1043207,  662720,  812597, -812597,  662720,
	 923241,  497130, -497130,  923241,  301306, 1004354,-1004354,  301306,
	1002486,  307463, -307463, 1002486,  491456,  926274, -926274,  491456,
	 808516,  667693, -667693,  808516,   99576, 1043837,-1043837,   99576,
	1047150,   54664,  -54664, 1047150,  701794,  779100, -779100,  701794,
	 946522,  451230, -451230,  946522,  350224,  988360, -988360,  350224,
	1016365,  257903, -257903, 1016365,  536314,  901043, -901043,  536314,
	 840304,  627217, -627217,  840304,  150675, 1037694,-1037694,  150675,
	1036750,  157039, -157039, 1036750,  622049,  844137, -844137,  622049,
	 897736,  541833, -541833,  897736,  251661, 1017928,-1017928,  251661,
	 986192,  356282, -356282,  986192,  445414,  949272, -949272,  445414,
	 774780,  706561, -706561,  774780,   48238, 1047466,-1047466,   48238,
	1048176,   28949,  -28949, 1048176,  720702,  761643, -761643,  720702,
	 957310,  427865, -427865,  957310,  374374,  979467, -979467,  374374,
	1022388,  232882, -232882, 1022388,  558265,  887610, -887610,  558265,
	 855443,  606406, -606406,  855443,  176096, 1033684,-1033684,  176096,
	1040292,  131549, -131549, 1040292,  642578,  828616, -828616,  642578,
	 910762,  519638, -519638,  910762,  276567, 1011446,-1011446,  276567,
	 994639,  331972, -331972,  994639,  468576,  938056, -938056,  468576,
	 791886,  687334, -687334,  791886,   73929, 1045967,-1045967,   73929,
	1045493,   80346,  -80346, 1045493,  682462,  796089, -796089,  682462,
	 935163,  474323, -474323,  935163,  325863,  996657, -996657,  325863,
	1009730,  282768, -282768, 1009730,  514040,  913934, -913934,  514040,
	 824658,  647650, -647650,  824658,  125163, 1041079,-1041079,  125163,
	1032584,  182435, -182435, 1032584,  601146,  859148, -859148,  601146,
	 884168,  563701, -563701,  884168,  226604, 1023798,-1023798,  226604,
	 977151,  380377, -380377,  977151,  421983,  959918, -959918,  421983,
	 757206,  725362, -725362,  757206,   22517, 1048334,-1048334,   22517,
	1048453,   16084,  -16084, 1048453,  729995,  752741, -752741,  729995,
	 962489,  416085, -416085,  962489,  386365,  974799, -974799,  386365,
	1025169,  220318, -220318, 1025169,  569115,  880692, -880692,  569115,
	 862821,  595863, -595863,  862821,  188768, 1031445,-1031445,  188768,
	1041828,  118773, -118773, 1041828,  652698,  820669, -820669,  652698,
	 917071,  508422, -508422,  917071,  288958, 1007976,-1007976,  288958,
	 998638,  319741, -319741,  998638,  480052,  932235, -932235,  480052,
	 800261,  677565, -677565,  800261,   86759, 1044981,-1044981,   86759,
	1046401,   67510,  -67510, 1046401,  692180,  787654, -787654,  692180,
	 940913,  462811, -462811,  940913,  338069,  992583, -992583,  338069,
	1013124,  270356, -270356, 1013124,  525216,  907557, -907557,  525216,
	 832544,  637482, -637482,  832544,  137930, 1039465,-1039465,  137930,
	1034745,  169750, -169750, 1034745,  611643,  851706, -851706,  611643,
	 891019,  552808, -552808,  891019,  239151, 1020940,-1020940,  239151,
	 981746,  368357, -368357,  981746,  433731,  954667, -954667,  433731,
	 766051,  716015, -716015,  766051,   35380, 1047979,-1047979,   35380,
	1047742,   41810,  -41810, 1047742,  711302,  770430, -770430,  711302,
	 951988,  439581, -439581,  951988,  362326,  983987, -983987,  362326,
	1019453,  245411, -245411, 1019453,  547331,  894394, -894394,  547331,
	 847937,  616858, -616858,  847937,  163398, 1035767,-1035767,  163398,
	1038599,  144305, -144305, 1038599,  632361,  836439, -836439,  632361,
	 904317,  530775, -530775,  904317,  264134, 1014763,-1014763,  264134,
	 990490,  344153, -344153,  990490,  457029,  943735, -943735,  457029,
	 783392,  697000, -697000,  783392,   61088, 1046795,-1046795,   61088,
	1044429,   93170,  -93170, 1044429,  672642,  804403, -804403,  672642,
	 929272,  485763, -485763,  929272,  313608, 1000581,-1000581,  313608,
	1006184,  295137, -295137, 1006184,  502786,  920173, -920173,  502786,
	 816648,  657721, -657721,  816648,  112378, 1042537,-1042537,  112378,
	1030267,  195093, -195093, 1030267,  590557,  866460, -866460,  590557,
	 877184,  574509, -574509,  877184,  214024, 1026502,-1026502,  214024,
	 972410,  392339, -392339,  972410,  410172,  965024, -965024,  410172,
	 748248,  734600, -734600,  748248,    9651, 1048532,-1048532,    9651,
	1048532,    9651,   -9651, 1048532,  734600,  748248, -748248,  734600,
	 965024,  410172, -410172,  965024,  392339,  972410, -972410,  392339,
	1026502,  214024, -214024, 1026502,  574509,  877184, -877184,  574509,
	 866460,  590557, -590557,  866460,  195093, 1030267,-1030267,  195093,
	1042537,  112378, -112378, 1042537,  657721,  816648, -816648,  657721,
	 920173,  502786, -502786,  920173,  295137, 1006184,-1006184,  295137,
	1000581,  313608, -313608, 1000581,  485763,  929272, -929272,  485763,
	 804403,  672642, -672642,  804403,   93170, 1044429,-1044429,   93170,
	1046795,   61088,  -61088, 1046795,  697000,  783392, -783392,  697000,
	 943735,  457029, -457029,  943735,  344153,  990490, -990490,  344153,
	1014763,  264134, -264134, 1014763,  530775,  904317, -904317,  530775,
	 836439,  632361, -632361,  836439,  144305, 1038599,-1038599,  144305,
	1035767,  163398, -163398, 1035767,  616858,  847937, -847937,  616858,
	 894394,  547331, -547331,  894394,  245411, 1019453,-1019453,  245411,
	 983987,  362326, -362326,  983987,  439581,  951988, -951988,  439581,
	 770430,  711302, -711302,  770430,   41810, 1047742,-1047742,   41810,
	1047979,   35380,  -35380, 1047979,  716015,  766051, -766051,  716015,
	 954667,  433731, -433731,  954667,  368357,  981746, -981746,  368357,
	1020940,  239151, -239151, 1020940,  552808,  891019, -891019,  552808,
	 851706,  611643, -611643,  851706,  169750, 1034745,-1034745,  169750,
	1039465,  137930, -137930, 1039465,  637482,  832544, -832544,  637482,
	 907557,  525216, -525216,  907557,  270356, 1013124,-1013124,  270356,
	 992583,  338069, -338069,  992583,  462811,  940913, -940913,  462811,
	 787654,  692180, -692180,  787654,   67510, 1046401,-1046401,   67510,
	1044981,   86759,  -86759, 1044981,  677565,  800261, -800261,  677565,
	 932235,  480052, -480052,  932235,  319741,  998638, -998638,  319741,
	1007976,  288958, -288958, 1007976,  508422,  917071, -917071,  508422,
	 820669,  652698, -652698,  820669,  118773, 1041828,-1041828,  118773,
	1031445,  188768, -188768, 1031445,  595863,  862821, -862821,  595863,
	 880692,  569115, -569115,  880692,  220318, 1025169,-1025169,  220318,
	 974799,  386365, -386365,  974799,  416085,  962489, -962489,  416085,
	 752741,  729995, -729995,  752741,   16084, 1048453,-1048453,   16084,
	1048334,   22517,  -22517, 1048334,  725362,  757206, -757206,  725362,
	 959918,  421983, -421983,  959918,  380377,  977151, -977151,  380377,
	1023798,  226604, -226604, 1023798,  563701,  884168, -884168,  563701,
	 859148,  601146, -601146,  859148,  182435, 1032584,-1032584,  182435,
	1041079,  125163, -125163, 1041079,  647650,  824658, -824658,  647650,
	 913934,  514040, -514040,  913934,  282768, 1009730,-1009730,  282768,
	 996657,  325863, -325863,  996657,  474323,  935163, -935163,  474323,
	 796089,  682462, -682462,  796089,   80346, 1045493,-1045493,   80346,
	1045967,   73929,  -73929, 1045967,  687334,  791886, -791886,  687334,
	 938056,  468576, -468576,  938056,  331972,  994639, -994639,  331972,
	1011446,  276567, -276567, 1011446,  519638,  910762, -910762,  519638,
	 828616,  642578, -642578,  828616,  131549, 1040292,-1040292,  131549,
	1033684,  176096, -176096, 1033684,  606406,  855443, -855443,  606406,
	 887610,  558265, -558265,  887610,  232882, 1022388,-1022388,  232882,
	 979467,  374374, -374374,  979467,  427865,  957310, -957310,  427865,
	 761643,  720702, -720702,  761643,   28949, 1048176,-1048176,   28949,
	1047466,   48238,  -48238, 1047466,  706561,  774780, -774780,  706561,
	 949272,  445414, -445414,  949272,  356282,  986192, -986192,  356282,
	1017928,  251661, -251661, 1017928,  541833,  897736, -897736,  541833,
	 844137,  622049, -622049,  844137,  157039, 1036750,-1036750,  157039,
	1037694,  150675, -150675, 1037694,  627217,  840304, -840304,  627217,
	 901043,  536314, -536314,  901043,  257903, 1016365,-1016365,  257903,
	 988360,  350224, -350224,  988360,  451230,  946522, -946522,  451230,
	 779100,  701794, -701794,  779100,   54664, 1047150,-1047150,   54664,
	1043837,   99576,  -99576, 1043837,  667693,  808516, -808516,  667693,
	 926274,  491456, -491456,  926274,  307463, 1002486,-1002486,  307463,
	1004354,  301306, -301306, 1004354,  497130,  923241, -923241,  497130,
	 812597,  662720, -662720,  812597,  105979, 1043207,-1043207,  105979,
	1029051,  201411, -201411, 1029051,  585230,  870068, -870068,  585230,
	 873642,  579880, -579880,  873642,  207721, 1027795,-1027795,  207721,
	 969984,  398299, -398299,  969984,  404243,  967522, -967522,  404243,
	 743726,  739177, -739177,  743726,    3217, 1048571,-1048571,    3217,
};

fpp ffp_mul(fpp x, int64_t rt)
{
	return (x * rt) / (1 << 20);
	/* int64_t alo, ahi;

	ahi = x >> 32;
	alo = x & 0xFFFFFFFF;

	alo = (alo * rt) >> 20;
	ahi = (ahi * rt) << 12;
	return alo + ahi; */
}

void
fpp_FFT(fpp *f, unsigned logn)
{
	/*
	 * FFT algorithm in bit-reversal order uses the following
	 * iterative algorithm:
	 *
	 *   t = N
	 *   for m = 1; m < N; m *= 2:
	 *       ht = t/2
	 *       for i1 = 0; i1 < m; i1 ++:
	 *           j1 = i1 * t
	 *           s = GM[m + i1]
	 *           for j = j1; j < (j1 + ht); j ++:
	 *               x = f[j]
	 *               y = s * f[j + ht]
	 *               f[j] = x + y
	 *               f[j + ht] = x - y
	 *       t = ht
	 *
	 * GM[k] contains w^rev(k) for primitive root w = exp(i*pi/N).
	 *
	 * In the description above, f[] is supposed to contain complex
	 * numbers. In our in-memory representation, the real and
	 * imaginary parts of f[k] are in array slots k and k+N/2.
	 *
	 * We only keep the first half of the complex numbers. We can
	 * see that after the first iteration, the first and second halves
	 * of the array of complex numbers have separate lives, so we
	 * simply ignore the second part.
	 */

	unsigned u;
	size_t t, n, hn, m;

	/*
	 * First iteration: compute f[j] + i * f[j+N/2] for all j < N/2
	 * (because GM[1] = w^rev(1) = w^(N/2) = i).
	 * In our chosen representation, this is a no-op: everything is
	 * already where it should be.
	 */

	/*
	 * Subsequent iterations are truncated to use only the first
	 * half of values.
	 */
	n = MKN(logn);
	hn = n >> 1;
	t = hn;

	for (u = 1, m = 2; u < logn; u ++, m <<= 1) {
		size_t ht, hm, i1, j1;

		ht = t >> 1;
		hm = m >> 1;
		for (i1 = 0, j1 = 0; i1 < hm; i1 ++, j1 += t) {
			size_t j, j2;

			j2 = j1 + ht;
			int64_t s_re, s_im;

			s_re = fpp_gm_tab[((m + i1) << 1) + 0];
			s_im = fpp_gm_tab[((m + i1) << 1) + 1];
			for (j = j1; j < j2; j ++) {
				fpp x_re, x_im, y_re, y_im, tmp;

				x_re = f[j];
				x_im = f[j + hn];
				y_re = f[j + ht];
				y_im = f[j + ht + hn];

				tmp  = fpp_sub(ffp_mul(y_re, s_re), ffp_mul(y_im, s_im));
				y_im = fpp_add(ffp_mul(y_re, s_im), ffp_mul(y_im, s_re));
				y_re = tmp;

				f[j      ] = fpp_add(x_re, y_re);
				f[j   +hn] = fpp_add(x_im, y_im);
				f[j+ht   ] = fpp_sub(x_re, y_re);
				f[j+ht+hn] = fpp_sub(x_im, y_im);
			}
		}
		t = ht;

		if (u % 2 == 0) {
			for (j1 = 0; j1 < n; j1++)
				f[j1] >>= 1;
		}
	}
}

void
fpp_iFFT(fpp *f, unsigned logn)
{
	/*
	 * Inverse FFT algorithm in bit-reversal order uses the following
	 * iterative algorithm:
	 *
	 *   t = 1
	 *   for m = N; m > 1; m /= 2:
	 *       hm = m/2
	 *       dt = t*2
	 *       for i1 = 0; i1 < hm; i1 ++:
	 *           j1 = i1 * dt
	 *           s = iGM[hm + i1]
	 *           for j = j1; j < (j1 + t); j ++:
	 *               x = f[j]
	 *               y = f[j + t]
	 *               f[j] = x + y
	 *               f[j + t] = s * (x - y)
	 *       t = dt
	 *   for i1 = 0; i1 < N; i1 ++:
	 *       f[i1] = f[i1] / N
	 *
	 * iGM[k] contains (1/w)^rev(k) for primitive root w = exp(i*pi/N)
	 * (actually, iGM[k] = 1/GM[k] = conj(GM[k])).
	 *
	 * In the main loop (not counting the final division loop), in
	 * all iterations except the last, the first and second half of f[]
	 * (as an array of complex numbers) are separate. In our chosen
	 * representation, we do not keep the second half.
	 *
	 * The last iteration recombines the recomputed half with the
	 * implicit half, and should yield only real numbers since the
	 * target polynomial is real; moreover, s = i at that step.
	 * Thus, when considering x and y:
	 *    y = conj(x) since the final f[j] must be real
	 *    Therefore, f[j] is filled with 2*Re(x), and f[j + t] is
	 *    filled with 2*Im(x).
	 * But we already have Re(x) and Im(x) in array slots j and j+t
	 * in our chosen representation. That last iteration is thus a
	 * simple doubling of the values in all the array.
	 *
	 * We make the last iteration a no-op by tweaking the final
	 * division into a division by N/2, not N.
	 */
	size_t u, n, hn, t, m;

	n = MKN(logn);
	t = 1;
	m = n;
	hn = n >> 1;
	for (u = logn; u > 1; u --) {
		size_t hm, dt, i1, j1;

		hm = m >> 1;
		dt = t << 1;
		for (i1 = 0, j1 = 0; j1 < hn; i1 ++, j1 += dt) {
			size_t j, j2;

			j2 = j1 + t;
			fpp s_re, s_im;

			s_re = fpp_gm_tab[((hm + i1) << 1) + 0];
			s_im = fpp_neg(fpp_gm_tab[((hm + i1) << 1) + 1]);
			for (j = j1; j < j2; j ++) {
				fpp x_re, x_im, y_re, y_im, tmp;

				x_re = f[j];
				x_im = f[j + hn];
				y_re = f[j + t];
				y_im = f[j + t + hn];

				f[j     ] = fpp_add(x_re, y_re);
				f[j + hn] = fpp_add(x_im, y_im);

				x_re = fpp_sub(x_re, y_re);
				x_im = fpp_sub(x_im, y_im);

				tmp = fpp_sub(
					ffp_mul(x_re, s_re), ffp_mul(x_im, s_im));
				f[j + t + hn] = fpp_add(
					ffp_mul(x_re, s_im), ffp_mul(x_im, s_re));
				f[j + t     ] = tmp;
			}
		}
		t = dt;
		m = hm;

		for (j1 = 0; j1 < n; j1++)
			f[j1] >>= 1;
	}

	/*
	 * Last iteration is a no-op, provided that we divide by N/2
	 * instead of N. We need to make a special case for logn = 0.
	 */
	/* if (logn > 0) {
		for (u = 0; u < n; u ++) {
			f[u] >>= logn - 1;
		}
	} */
}
// =============================================================================

/* see inner.h */
int
Zf(uncompressed_verify_NTT)(const uint8_t *restrict h,
	const int16_t *restrict s0, const int16_t *restrict s1,
	const int16_t *restrict q00, const int16_t *restrict q10,
	unsigned logn, uint8_t *restrict tmp)
{
	size_t n;
	uint32_t *q10_i32, p, p0i;

	n = MKN(logn);

	p = PRIMES[0];
	p0i = modp_ninv31(p);
	q10_i32 = ((uint32_t *)tmp) + 3*n;
	int16_to_ntt(q10_i32, q10, vrfy_gms[0], p, p0i, logn);

	return verify_norm_NTT(h, s0, s1, q00, q10, logn, tmp);
}

/* see inner.h */
int Zf(verify_NTT)(const uint8_t *restrict h,
	const int16_t *restrict s1,
	const int16_t *restrict q00, const int16_t *restrict q10,
	unsigned logn, uint8_t *restrict tmp)
{
	/*
	 * Recover s0 with s0 = round(h0 / 2 + (h1 / 2 - s1) q10 / q00)
	 * = round((h0 q00 + (h1 - 2 s1) q10) / (2q00)).
	 * Put (t0, t1) = (h0 - 2 * s0, h1 - 2 * s1) in FFT representation.
	 *
	 * Use floats only here...
	 */

	size_t n, hn, u, v, w;
	int16_t *s0;
	uint32_t p, p0i, R2, *q10_i32, *s1_i32;
	const uint32_t *gm;
	fpp *t0, *t1;
	uint8_t h0;

	n = MKN(logn);
	hn = n >> 1;

	t0 = (fpp *)tmp;
	t1 = t0 + n;

	gm = vrfy_gms[0];

	s0 = (int16_t *)(tmp + 16*n);
	q10_i32 = (uint32_t *)s0;
	s1_i32 = ((uint32_t *)tmp) + 3*n;

	p = PRIMES[0];
	p0i = modp_ninv31(p);
	R2 = modp_R2(p, p0i);

	int16_to_ntt(q10_i32, q10, gm, p, p0i, logn);
	hash_to_ntt(s1_i32, SECOND_HASH(h, logn), s1, gm, R2, p, p0i, logn);
	for (u = 0; u < n; u++) {
		s1_i32[u] = modp_montymul(s1_i32[u], q10_i32[u], p, p0i);
	}

	/*
	 * Convert (h1 - 2 s1) q10, calculated in NTT, to FFT format, so we can do
	 * division and rounding.
	 */
	modp_iNTT2(s1_i32, vrfy_igms[0], logn, p, p0i);

	for (u = 0; u < n; u++) {
		t0[u] = fpp_of(modp_norm(s1_i32[u], p));
	}

	for (u = 0; u < n; u++) {
		t1[u] = fpp_of(q00[u]);
	}
	fpp_FFT(t0, logn);
	fpp_FFT(t1, logn);

	for (u = 0; u < hn; u++) {
		t0[u] = fpp_div(t0[u], t1[u]);
		t0[u + hn] = fpp_div(t0[u + hn], t1[u]);
	}
	fpp_iFFT(t0, logn);

	/*
	 * verify_norm_NTT expects that q10 is in NTT representation in the second
	 * half of t1.
	 */
	memcpy(s1_i32, q10_i32, n * sizeof *q10_i32);

	/*
	 * Recover s0 with s0 = round(h0 / 2 + (h1 / 2 - s1) q10 / q00).
	 * Put (t0, t1) = (h0 - 2 * s0, h1 - 2 * s1) in FFT representation.
	 */
	if (logn <= 3) {
		h0 = h[0];
		for (u = 0; u < n; u ++) {
			s0[u] = fpp_rint(fpp_half(fpp_add(fpp_of(h0 & 1), t0[u])));
			h0 >>= 1;
		}
	} else {
		for (u = 0, w = 0; w < n; u ++) {
			h0 = h[u];
			for (v = 0; v < 8; v ++, w ++) {
				s0[w] = fpp_rint(fpp_half(fpp_add(fpp_of(h0 & 1), t0[w])));
				h0 >>= 1;
			}
		}
	}

	return verify_norm_NTT(h, s0, s1, q00, q10, logn, tmp);
}
