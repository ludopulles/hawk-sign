/*
 * Make sure that keygen is deterministic with a given seed.
 */
#include <assert.h>
#include <stdio.h>

#include "../inner.h"

int8_t _f[512] = {1,0,-3,3,2,0,1,1,-1,2,0,-1,1,2,3,0,-2,0,0,2,0,-3,1,0,0,1,-1,0,-3,0,-2,1,-2,0,0,1,1,0,-1,0,-3,-1,0,1,2,0,-2,0,-1,1,0,-1,0,-1,1,1,-2,-1,0,2,3,-3,1,1,2,-2,1,0,-1,-1,1,1,2,-1,0,0,2,3,3,3,2,0,0,1,2,0,-2,-2,-1,2,-2,-2,1,0,1,-2,-1,-2,2,1,0,1,0,1,0,0,2,1,0,-1,0,-2,-1,0,0,0,0,2,-1,-2,0,0,1,2,-1,2,1,-1,2,0,-2,3,-4,1,1,-2,1,0,0,-2,1,0,1,-2,-2,0,-2,-2,0,-1,0,-2,-1,1,1,-2,-4,2,0,0,0,1,0,-1,2,1,1,1,0,-1,1,4,0,3,0,-2,1,-2,0,0,0,-1,0,0,1,0,2,1,-2,0,0,-1,1,-2,0,0,0,2,1,-1,0,0,-1,0,-1,2,1,-2,0,2,0,-2,1,3,3,1,2,0,0,2,-1,0,0,1,0,-1,1,-1,-1,3,1,-1,2,1,-2,0,-2,2,-2,2,-4,1,0,3,-1,0,2,0,-1,-1,0,-2,0,0,-1,-2,0,-2,-1,1,-2,-2,0,-1,-1,-1,0,2,2,4,-2,0,0,1,0,1,2,1,-3,0,-4,-1,1,0,1,0,1,0,2,0,-1,1,1,-1,1,2,0,-1,1,1,2,1,2,0,0,1,1,-1,-2,-2,-1,-1,1,1,-2,0,1,-1,-2,1,-1,2,1,0,3,0,1,-1,2,-2,0,2,3,2,-1,-3,1,1,0,2,0,-2,1,-3,0,0,0,1,0,-1,2,0,1,-1,-4,0,2,-1,0,1,-1,1,0,2,2,3,2,1,0,1,1,0,1,1,0,1,-1,1,1,0,1,2,-2,-4,-2,-1,0,-2,0,-1,0,0,-1,2,1,-2,3,2,-1,1,-2,1,0,-1,-1,0,-1,-1,0,-2,-2,-3,0,1,-2,-2,-2,1,-1,0,0,2,-2,3,1,4,2,2,0,-1,-3,-1,1,0,2,1,-2,0,0,-2,-2,-2,-1,-1,-1,0,-1,-1,0,-1,0,-2,1,0,3,-2,2,1,1,0,0,1,-2,-1,4,1,4,-2,-1,0,2,0,-1,-2,-2,3,-1,0,-3,-1,1,-1,1,0,-1,0,-1,0,-3,0,0,-1,1,-2,0,1,2,0,-1,1,1,-2,3,0,-1,-1,2,1,3,1,-2,0,};
int8_t _g[512] = {0,1,1,-1,-2,0,-3,2,-2,0,-1,-2,-1,-1,-1,2,1,-1,-4,1,-2,-3,0,0,1,1,1,-2,0,2,0,-1,-2,-2,-1,0,-2,2,-2,-1,-3,-1,-2,0,-1,0,-2,-1,2,0,-1,-3,0,-2,2,0,0,1,1,2,0,0,0,0,2,-1,-2,1,1,-1,0,1,2,1,-1,0,0,-1,-1,1,-2,-1,1,2,-2,-1,0,-1,-2,0,-1,2,3,-3,3,-1,0,0,2,1,-3,1,0,0,-2,0,2,-3,2,1,-1,-1,-1,3,0,0,1,1,2,1,-4,2,1,0,-2,1,-2,2,0,-1,3,-1,1,0,1,-1,1,1,0,1,2,0,-2,1,0,-3,1,1,1,-1,0,-1,-2,-1,0,2,-1,-1,0,1,0,-1,-2,-1,0,1,1,-1,-1,-2,-1,1,1,1,-2,1,1,0,0,-1,0,-4,-2,2,-1,1,1,-1,1,0,0,2,0,0,0,0,-1,-2,0,-1,-1,0,-2,2,0,-4,1,0,-1,-4,0,0,1,2,1,0,0,1,1,-1,1,-2,2,-1,0,0,-1,2,1,-2,1,-2,0,1,2,-1,1,-2,2,0,-1,3,1,1,0,-1,1,-1,-3,0,4,2,-1,-1,1,3,-2,1,-3,0,-1,-2,-1,0,2,-1,-1,-2,1,1,-3,3,-3,-1,1,-2,-2,0,1,0,0,0,2,0,-1,0,0,-2,1,1,-1,0,-2,0,3,1,0,2,-4,-1,2,3,1,1,-1,0,1,1,0,-2,-1,0,0,2,-3,-1,0,1,1,-1,0,-2,0,1,1,0,0,0,2,0,1,3,2,0,1,1,1,0,0,1,4,1,-2,-2,2,0,0,2,-1,-2,0,1,1,-1,0,1,1,0,-2,2,1,-1,-2,3,1,0,0,-1,1,-1,0,0,0,-1,0,-1,-2,2,2,1,0,-1,-1,-3,-2,0,-2,1,2,-2,0,1,0,-1,1,1,0,1,1,0,-2,0,2,0,-1,-2,0,1,0,1,0,0,1,3,0,2,-1,0,3,-2,-2,2,-1,-2,0,0,0,2,-2,-1,-1,1,3,-1,0,1,-1,1,0,1,1,-1,2,1,0,0,-1,-1,1,-3,-2,1,-2,-3,0,3,-2,0,2,-3,-1,0,0,3,1,0,-2,-2,1,1,-1,-1,0,-4,-1,0,0,-1,-1,-1,0,0,-1,1,0,-1,0,-1,1,0,-1,-2,3,0,-5,-1,0,-2,-1,-2,-3,3,1,-2,-1,-1,0,2,1,-1,-1,-1,};
int8_t _F[512] = {-5,-7,-6,5,2,21,-12,-9,13,-10,-8,-3,8,4,-11,3,9,12,-9,-10,-2,-4,13,4,-14,13,5,-8,5,-3,1,-9,7,4,-3,-4,6,-4,12,-11,11,1,17,17,-3,14,9,-12,-1,5,-8,-3,-7,-4,-5,-6,-19,14,-4,6,11,-9,5,-4,-7,-1,-7,-4,13,-5,-14,-5,1,-4,-11,-2,-3,4,-3,-6,-2,-1,3,-2,2,4,8,-13,-6,-1,10,14,-6,-4,3,-5,3,-7,-2,-2,-6,-2,1,-1,5,0,-14,-21,-4,9,-3,-7,-1,-2,-4,11,1,9,5,-3,-3,-6,11,-9,-1,4,-9,-18,4,-1,7,13,-10,-5,-5,5,-3,-1,18,5,9,-4,13,-3,-1,-8,-4,-6,3,24,-9,-22,-4,-10,4,-3,-10,-12,4,-5,11,-1,15,-1,0,7,-15,10,4,1,4,-9,-6,12,3,11,8,6,16,7,-12,-14,2,-4,-13,5,-8,12,-4,11,6,5,4,3,23,-1,5,-6,-4,7,8,-3,-10,-7,-12,-4,-6,-16,-8,-19,-3,-9,-10,-10,7,-6,7,6,-9,4,17,1,-19,0,-11,-7,5,-13,3,-17,-8,8,5,7,14,7,3,3,-12,2,10,2,8,2,-4,-7,9,6,1,1,13,8,-4,-12,-12,-6,3,-2,-5,14,-11,-2,11,6,2,-5,-6,-2,-4,-14,0,6,8,7,-10,-11,-3,10,-4,3,-2,-12,6,3,-6,10,-17,-7,7,11,-8,5,4,2,12,11,8,-1,-2,11,8,-6,10,19,18,-9,-6,7,-7,1,-9,5,0,-5,-8,5,-5,-18,1,0,5,14,2,-4,6,-2,0,-6,4,8,2,2,13,11,-1,-4,9,8,18,-10,-2,-11,10,-8,6,-4,-19,-15,-5,5,-12,-4,-3,11,-2,6,19,15,10,-11,6,4,-15,-22,-5,-2,11,-14,7,5,-5,12,-15,7,5,2,2,-13,5,3,1,17,10,8,6,4,2,1,1,-3,-5,-12,-7,-5,0,-5,4,6,1,10,-1,9,8,10,3,9,-10,2,-10,2,18,-4,1,2,0,1,10,-15,-15,-9,-8,-15,12,6,1,12,1,-4,18,9,19,1,-8,-3,-6,0,11,-3,-9,2,12,-19,7,-6,13,-4,2,-11,-1,0,21,-5,-11,5,-7,10,1,-6,-5,11,14,-9,-8,-1,-10,5,4,3,4,2,11,6,-3,8,12,0,-2,-8,-2,1,-13,-11,5,-16,3,8,1,8,-5,-7,0,-3,-7,11,-11,-2,-2,-11,12,-2,10,-12,8,17,5,8,0,-10,4,-4,-5,9,};
int8_t _G[512] = {-10,-3,-10,1,18,-5,2,5,-7,16,-6,-11,-7,6,-4,10,6,7,3,-1,4,-2,-15,-3,10,-11,5,11,0,-9,22,4,7,5,3,4,-7,-7,7,4,1,-15,11,-2,4,7,-7,14,-12,-5,-3,-2,2,18,6,-16,-12,14,5,6,4,2,10,-3,7,4,-11,4,-7,-5,9,9,-12,5,-2,-7,8,0,-12,-3,6,15,0,-4,13,-7,-17,-5,-2,12,-3,5,11,-9,-2,15,-7,-3,16,-7,3,-5,-19,-5,7,-3,-1,-8,7,2,5,-4,-17,-5,-3,-1,11,-19,3,2,-15,2,3,-7,4,-3,-10,-18,4,-8,-1,11,-2,-14,-2,1,6,4,-20,-2,-1,-3,4,6,6,-5,-12,2,23,-4,-4,-2,-7,3,1,2,15,-9,-5,-2,-1,0,-4,0,1,-6,6,-3,7,6,-2,13,-4,7,7,-5,0,-1,5,-13,5,9,0,0,15,-10,-6,-5,-15,3,-4,10,4,-3,11,6,7,-1,13,-3,-6,8,2,-4,-2,-9,9,-1,12,1,0,-11,-4,-8,16,1,-4,-1,-9,1,4,-8,13,-6,-11,-9,1,1,6,-9,0,11,-6,18,-12,-7,13,4,-12,-6,-1,-10,5,-9,5,7,10,-1,-11,-6,-8,-8,8,-17,1,11,-3,10,0,11,-4,11,-10,-15,15,-12,-14,-8,2,4,1,-11,4,5,-5,-2,-13,-2,2,-9,-1,-10,16,11,16,0,-17,8,12,13,-15,5,-2,-5,-2,-16,8,-9,4,8,7,-5,-6,-8,18,16,-9,-10,9,16,-1,11,-16,19,0,-11,-14,-7,-3,13,-17,-12,4,-12,-14,-4,8,-14,4,-2,5,9,-3,5,2,-12,12,5,-2,8,-9,1,-14,2,4,-18,0,1,-6,16,0,-8,5,-2,24,14,-11,16,3,-1,19,7,-7,-10,-6,-13,-1,11,9,13,0,-3,4,8,-1,3,0,6,10,-5,-4,-6,-7,-7,-8,0,2,-9,12,-12,5,19,-13,11,14,-3,5,-9,-4,4,5,8,-11,0,-4,5,-7,-2,-1,6,5,-6,7,7,4,18,4,-10,-8,-8,9,0,-1,4,6,12,-4,-5,-1,10,-5,0,-18,-8,1,9,-6,-3,-6,-21,10,-18,-9,11,-16,18,1,-17,5,-1,14,-1,2,3,-13,-11,-10,-5,-8,-8,-14,2,4,-8,0,-3,8,-5,18,-4,-2,5,-5,10,13,-16,-4,4,7,-15,-7,3,3,-6,-7,7,7,11,-5,-7,2,7,-7,7,7,0,-4,1,-8,-10,20,2,-6,-15,7,-18,-6,-4,14,14,-11,-2,};

int poly_eq(int8_t *p, int8_t *q, unsigned logn) {
	for (size_t u = 0, n = MKN(logn); u < n; u ++)
		if (p[u] != q[u]) return 0;
	return 1;
}

void output_poly(int8_t *p, unsigned logn) {
	printf("{");
	for (size_t u = 0, n = MKN(logn); u < n; u ++)
		printf("%d,", p[u]);
	printf("}\n");
}

// =============================================================================
// | TESTING CODE                                                              |
// =============================================================================
#define N (512)
// 56, 144, 320, 672, 1376, 2784, 5600, 11232, 22496

void measure_keygen(unsigned logn, unsigned char *seed, size_t seed_len) {
	size_t n;
	uint8_t b[100 * N];
	int8_t f[N], g[N], F[N], G[N];
	fpr q00[N], q01[N], q11[N];
	int16_t q00n[N], q01n[N];
	inner_shake256_context sc;

	n = MKN(logn);

	// Initialize a RNG.
	inner_shake256_init(&sc);
	inner_shake256_inject(&sc, seed, seed_len);
	inner_shake256_flip(&sc);

	memset(b, (uint8_t) -1, sizeof b);
	Zf(keygen)(&sc, f, g, F, G, q00, q01, NULL, logn, b);

	int len = sizeof b;
	while (b[len - 1] == (uint8_t) -1) len--;
	// printf("Total used length: %d\n", len);
	assert(len == 44 * n - 32);

	/* output_poly(f, logn);
	output_poly(g, logn);
	output_poly(F, logn);
	output_poly(G, logn); */

	if (logn == 9) {
		assert(poly_eq(f, _f, logn));
		assert(poly_eq(g, _g, logn));
		assert(poly_eq(F, _F, logn));
		assert(poly_eq(G, _G, logn));
	}
}

int main() {
	// includes trailing zero character
	unsigned char seed[12] = "determinism";

	for (int i = 9; i >= 1; i--) {
		measure_keygen(i, seed, sizeof seed);
	}
	return 0;
}
